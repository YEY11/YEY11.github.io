I"dµ<h1 id="lecture-05-autograd-ä¸é€»è¾‘å›å½’">Lecture 05 autograd ä¸é€»è¾‘å›å½’</h1>

<p>æœ¬èŠ‚è¯¾ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šPyTorch ä¸­çš„è‡ªåŠ¨æ±‚å¯¼ç³»ç»Ÿä»¥åŠé€»è¾‘å›å½’æ¨¡å‹ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œæ·±åº¦æ¨¡å‹çš„è®­ç»ƒå°±æ˜¯ä¸æ–­åœ°æ›´æ–°æƒå€¼ï¼Œè€Œæƒå€¼çš„æ›´æ–°éœ€è¦æ±‚è§£æ¢¯åº¦ï¼Œå› æ­¤ï¼Œæ¢¯åº¦åœ¨æˆ‘ä»¬çš„æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­æ˜¯è‡³å…³é‡è¦çš„ã€‚ç„¶è€Œï¼Œæ±‚è§£æ¢¯åº¦é€šå¸¸ååˆ†ç¹çï¼Œå› æ­¤ï¼ŒPyTorch ä¸­å¼•å…¥äº†è‡ªåŠ¨æ±‚å¯¼ç³»ç»Ÿå¸®åŠ©æˆ‘ä»¬å®Œæˆè¿™ä¸€è¿‡ç¨‹ã€‚åœ¨ PyTorch ä¸­ï¼Œæˆ‘ä»¬æ— éœ€æ‰‹åŠ¨è®¡ç®—æ¢¯åº¦ï¼Œåªéœ€è¦æ­å»ºå¥½å‰å‘ä¼ æ’­çš„è®¡ç®—å›¾ï¼Œç„¶åæ ¹æ® PyTorch ä¸­çš„ <code class="language-plaintext highlighter-rouge">autograd</code> æ–¹æ³•å°±å¯ä»¥å¾—åˆ°æ‰€æœ‰å¼ é‡çš„æ¢¯åº¦ã€‚</p>

<h2 id="1-autogradè‡ªåŠ¨æ±‚å¯¼ç³»ç»Ÿ">1. autogradï¼šè‡ªåŠ¨æ±‚å¯¼ç³»ç»Ÿ</h2>

<h4 id="torchautogradbackward"><code class="language-plaintext highlighter-rouge">torch.autograd.backward()</code></h4>

<p><strong>åŠŸèƒ½</strong>ï¼šè‡ªåŠ¨æ±‚å–è®¡ç®—å›¾ä¸­å„ç»“ç‚¹çš„æ¢¯åº¦ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">torch</span><span class="p">.</span><span class="n">autograd</span><span class="p">.</span><span class="n">backward</span><span class="p">(</span>
    <span class="n">tensors</span><span class="p">,</span>
    <span class="n">grad_tensors</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">retain_graph</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">create_graph</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ä¸»è¦å‚æ•°</strong>ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">tensors</code>ï¼šç”¨äºæ±‚å¯¼çš„å¼ é‡ï¼Œå¦‚ <code class="language-plaintext highlighter-rouge">loss</code>ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">retain_graph</code>ï¼šä¿å­˜è®¡ç®—å›¾ï¼ŒPyTorch é»˜è®¤åœ¨åå‘ä¼ æ’­å®Œæˆåä¸¢å¼ƒè®¡ç®—å›¾ï¼Œå¦‚éœ€ä¿å­˜åˆ™å°†è¯¥é¡¹è®¾ä¸º <code class="language-plaintext highlighter-rouge">True</code>ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">create_graph</code>ï¼šåˆ›å»ºå¯¼æ•°è®¡ç®—å›¾ï¼Œç”¨äºé«˜é˜¶æ±‚å¯¼ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">grad_tensors</code>ï¼šå¤šæ¢¯åº¦æƒé‡ï¼Œå½“æˆ‘ä»¬æœ‰å¤šä¸ª <code class="language-plaintext highlighter-rouge">loss</code> éœ€è¦è®¡ç®—æ¢¯åº¦çš„æ—¶å€™ï¼Œå°±éœ€è¦è®¾ç½®å„ä¸ª <code class="language-plaintext highlighter-rouge">loss</code> çš„æƒé‡æ¯”ä¾‹ã€‚</li>
</ul>

<p>å›é¡¾ä¸€ä¸‹å¦‚ä½•é€šè¿‡è®¡ç®—å›¾æ±‚è§£æ¢¯åº¦ï¼š</p>

\[y=(x+w) * (w+1)\]

<ul>
  <li>$a = x+w$</li>
  <li>$b=w+1$</li>
  <li>$y=a*b$</li>
</ul>

\[\begin{align}
\dfrac{\partial y}{\partial w} &amp;= \dfrac{\partial y}{\partial a} \dfrac{\partial a}{\partial w} + \dfrac{\partial y}{\partial b} \dfrac{\partial b}{\partial w} \\[2ex]
&amp;= b * 1+ a * 1 \\[2ex]
&amp;= (w+1) + (x + w) \\[2ex]
&amp;= 2*w + x + 1 \\[2ex]
&amp;= 2*1 + 2 + 1 = 5
\end{align}\]

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-10-WX20201210-153230%402x.png" width="40%" /></p>

<p><strong>ä»£ç ç¤ºä¾‹</strong>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">2.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># å¦‚æœå¸Œæœ›åé¢å†æ¬¡æ‰§è¡Œè¯¥è®¡ç®—å›¾ï¼Œå¯ä»¥å°† retain_graph å‚æ•°è®¾ä¸º True
# y.backward(retain_graph=True) 
</span>
<span class="n">y</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">grad</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>tensor([5.])
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å½“æœ‰å¤šä¸ª <code class="language-plaintext highlighter-rouge">loss</code> éœ€è¦è®¡ç®—æ¢¯åº¦æ—¶ï¼Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">grad_tensors</code> è®¾ç½®å„ <code class="language-plaintext highlighter-rouge">loss</code> æƒé‡æ¯”ä¾‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">2.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># y0 = (x+w) * (w+1)    dy0/dw = 2*w + x + 1 = 5
</span><span class="n">y0</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># y1 = (x+w) + (w+1)    dy1/dw = 2
</span><span class="n">y1</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>  

<span class="c1"># è¿™ç§æƒ…å†µä¸‹ï¼Œloss æ˜¯ä¸€ä¸ªå‘é‡ [y0, y1]
</span><span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">([</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># æ¢¯åº¦çš„æƒé‡ï¼šdy0/dw æƒé‡ä¸º 1ï¼Œdy1/dw æƒé‡ä¸º 2
</span><span class="n">grad_tensors</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">])</span>

<span class="c1"># gradient ä¼ å…¥ torch.autograd.backward() ä¸­çš„ grad_tensors
</span><span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">(</span><span class="n">gradient</span><span class="o">=</span><span class="n">grad_tensors</span><span class="p">)</span>  

<span class="k">print</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">grad</span><span class="p">)</span> <span class="c1"># 5*1 + 2*2 = 9
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>tensor([9.])
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="torchautogradgrad"><code class="language-plaintext highlighter-rouge">torch.autograd.grad()</code></h4>

<p><strong>åŠŸèƒ½</strong>ï¼šæ±‚å–æ¢¯åº¦ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">torch</span><span class="p">.</span><span class="n">autograd</span><span class="p">.</span><span class="n">grad</span><span class="p">(</span>
    <span class="n">outputs</span><span class="p">,</span>
    <span class="n">inputs</span><span class="p">,</span>
    <span class="n">grad_outputs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">retain_graph</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">create_graph</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ä¸»è¦å‚æ•°</strong>ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">outputs</code>ï¼šç”¨äºæ±‚å¯¼çš„å¼ é‡ï¼Œå¦‚ <code class="language-plaintext highlighter-rouge">loss</code>ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">inputs</code>ï¼šéœ€è¦æ¢¯åº¦çš„å¼ é‡ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">create_graph</code>ï¼šåˆ›å»ºå¯¼æ•°è®¡ç®—å›¾ï¼Œç”¨äºé«˜é˜¶æ±‚å¯¼ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">retain_graph</code>ï¼šä¿å­˜è®¡ç®—å›¾ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">grad_outputs</code>ï¼šå¤šæ¢¯åº¦æƒé‡ã€‚</li>
</ul>

<p><strong>æ±‚å–äºŒé˜¶æ¢¯åº¦</strong>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">3.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># y = x**2
</span>
<span class="c1"># grad_1 = dy/dx = 2x = 2 * 3 = 6
</span><span class="n">grad_1</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">autograd</span><span class="p">.</span><span class="n">grad</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">create_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
<span class="k">print</span><span class="p">(</span><span class="n">grad_1</span><span class="p">)</span>

<span class="c1"># grad_2 = d(dy/dx)/dx = d(2x)/dx = 2
</span><span class="n">grad_2</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">autograd</span><span class="p">.</span><span class="n">grad</span><span class="p">(</span><span class="n">grad_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>  
<span class="k">print</span><span class="p">(</span><span class="n">grad_2</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>(tensor([6.], grad_fn=&lt;MulBackward0&gt;),)
(tensor([2.]),)
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>æ³¨æ„äº‹é¡¹</strong>ï¼š</p>

<ol>
  <li>æ¢¯åº¦ä¸è‡ªåŠ¨æ¸…é›¶ã€‚</li>
  <li>ä¾èµ–äºå¶å­ç»“ç‚¹çš„ç»“ç‚¹ï¼Œ<code class="language-plaintext highlighter-rouge">requires_grad</code> é»˜è®¤ä¸º <code class="language-plaintext highlighter-rouge">True</code>ã€‚</li>
  <li>å¶å­ç»“ç‚¹ä¸å¯æ‰§è¡ŒåŸä½æ“ä½œ (in-place)ã€‚</li>
</ol>

<p><strong>ä»£ç ç¤ºä¾‹ 1</strong>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="c1"># 1. æ¢¯åº¦ä¸ä¼šè‡ªåŠ¨æ¸…é›¶ï¼Œé‡å¤æ±‚å–ä¼šå åŠ ï¼Œå¯ä»¥ä½¿ç”¨ .grad.zero_() æ–¹æ³•æ‰‹åŠ¨æ¸…é›¶
</span><span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">2.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">y</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">grad</span><span class="p">)</span>

<span class="c1"># æ¢¯åº¦æ¸…é›¶ï¼Œä¸‹åˆ’çº¿è¡¨ç¤ºåŸä½æ“ä½œ (in-place)
</span><span class="n">w</span><span class="p">.</span><span class="n">grad</span><span class="p">.</span><span class="n">zero_</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">y</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">grad</span><span class="p">)</span>
    <span class="n">w</span><span class="p">.</span><span class="n">grad</span><span class="p">.</span><span class="n">zero_</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>tensor([5.])
tensor([10.])
tensor([15.])
tensor([5.])
tensor([5.])
tensor([5.])
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ä»£ç ç¤ºä¾‹ 2</strong>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1"># 2. ä¾èµ–äºå¶å­ç»“ç‚¹çš„ç»“ç‚¹ï¼Œ requires_grad é»˜è®¤ä¸º True
</span><span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">2.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">y</span><span class="p">.</span><span class="n">requires_grad</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>True True True
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ä»£ç ç¤ºä¾‹ 3</strong>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1"># 3. å¶å­ç»“ç‚¹ä¸å¯æ‰§è¡Œ in-place (åŸä½æ“ä½œ)ã€‚å› ä¸º PyTorch è®¡ç®—å›¾ä¸­å¼•ç”¨å¶å­ç»“ç‚¹çš„å€¼æ˜¯
#    ç›´æ¥å¼•ç”¨å…¶å‰å‘ä¼ æ’­æ—¶çš„åœ°å€ï¼Œä¸ºäº†é˜²æ­¢è®¡ç®—å‡ºé”™ï¼Œå¶å­ç»“ç‚¹ä¸å¯æ‰§è¡Œ in-place æ“ä½œã€‚
</span>
<span class="c1">#    in-place (åŸä½æ“ä½œ): ä»åŸå§‹å†…å­˜åœ°å€ä¸­ç›´æ¥æ”¹å˜æ•°æ®ã€‚
#    é in-place æ“ä½œ: å¼€è¾Ÿä¸€å—æ–°çš„å†…å­˜åœ°å€å­˜å‚¨æ”¹å˜åçš„æ•°æ®ã€‚
</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span>

<span class="c1"># é in-place æ“ä½œ
</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">torch</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span>

<span class="c1"># in-place æ“ä½œ
</span><span class="n">a</span> <span class="o">+=</span> <span class="n">torch</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>4875211904 tensor([1.])
4875212336 tensor([2.])
4875212336 tensor([3.])
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>å¯¹å¶å­ç»“ç‚¹æ‰§è¡Œ in-place æ“ä½œå°†å¯¼è‡´æŠ¥é”™</strong>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">2.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># å¯¹éå¶å­ç»“ç‚¹ a æ‰§è¡Œé in-place æ“ä½œ
</span><span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># å¯¹éå¶å­ç»“ç‚¹ a æ‰§è¡Œ in-place æ“ä½œ
</span><span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">add_</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># å¯¹å¶å­ç»“ç‚¹ w æ‰§è¡Œé in-place æ“ä½œ
</span><span class="k">print</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># å¯¹å¶å­ç»“ç‚¹ w æ‰§è¡Œ in-place æ“ä½œï¼Œä¼šæŠ¥é”™
</span><span class="k">print</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">add_</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">y</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>tensor([4.], grad_fn=&lt;AddBackward0&gt;)
tensor([4.], grad_fn=&lt;AddBackward0&gt;)
tensor([2.], grad_fn=&lt;AddBackward0&gt;)
Traceback (most recent call last):
  File "&lt;input&gt;", line 1, in &lt;module&gt;
  File "/Applications/PyCharm.app/Contents/plugins/python/helpers/pydev/_pydev_bundle/pydev_umd.py", line 197, in runfile
    pydev_imports.execfile(filename, global_vars, local_vars)  # execute the script
  File "/Applications/PyCharm.app/Contents/plugins/python/helpers/pydev/_pydev_imps/_pydev_execfile.py", line 18, in execfile
    exec(compile(contents+"\n", file, 'exec'), glob, loc)
  File "/Users/andy/PycharmProjects/hello_pytorch/lesson/lesson-05/lesson-05-autograd.py", line 145, in &lt;module&gt;
    print(w.add_(1))
RuntimeError: a leaf Variable that requires grad is being used in an in-place operation.
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="2-é€»è¾‘å›å½’">2. é€»è¾‘å›å½’</h2>

<p><strong>é€»è¾‘å›å½’ (Logistic Regression)</strong> æ˜¯ <strong>çº¿æ€§</strong> çš„ <strong>äºŒåˆ†ç±»</strong> æ¨¡å‹ã€‚</p>

<p>æ¨¡å‹è¡¨è¾¾å¼ï¼š</p>

\[y=f(WX+b)\]

\[f(x)=\dfrac{1}{1+e^{-x}}\]

<p>å³ï¼š</p>

\[y=\dfrac{1}{1+e^{-(WX+b)}}\]

<p>è¿™é‡Œï¼Œæˆ‘ä»¬å°† $f(x)$ ç§°ä¸º Sigmoid å‡½æ•°ï¼Œåˆç§° Logistic å‡½æ•°ï¼š</p>

\[\text{class}=\begin{cases}0, &amp; y&lt; 0.5 \\[2ex] 1, &amp;  y \ge 0.5 \end{cases}\]

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-10-WX20201210-180559%402x.png" width="40%" /></p>

<p>çº¿æ€§å›å½’æ˜¯åˆ†æ <strong>è‡ªå˜é‡ $x$</strong> ä¸ <strong>å› å˜é‡ $y$ (æ ‡é‡)</strong> ä¹‹é—´å…³ç³»çš„æ–¹æ³•ï¼›è€Œé€»è¾‘å›å½’æ˜¯åˆ†æ <strong>è‡ªå˜é‡ $x$</strong> ä¸ <strong>å› å˜é‡ $y$ (æ¦‚ç‡)</strong> ä¹‹é—´å…³ç³»çš„æ–¹æ³•ã€‚</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-10-WX20201210-184101%402x.png" width="90%" /></p>

<p><strong>æœºå™¨å­¦ä¹ è®­ç»ƒçš„ 5 ä¸ªæ­¥éª¤</strong>ï¼š</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-11-WX20201211-145639%402x.png" width="90%" /></p>

<ol>
  <li><strong>æ•°æ®</strong>ï¼šæ•°æ®æ”¶é›†ã€æ¸…æ´—ã€åˆ’åˆ†ã€é¢„å¤„ç†ã€‚</li>
  <li><strong>æ¨¡å‹</strong>ï¼šæ ¹æ®ä»»åŠ¡çš„éš¾æ˜“ç¨‹åº¦ï¼Œé€‰æ‹©ç®€å•çš„çº¿æ€§æ¨¡å‹æˆ–è€…å¤æ‚çš„ç¥ç»ç½‘ç»œæ¨¡å‹ç­‰ç­‰ã€‚</li>
  <li><strong>æŸå¤±å‡½æ•°</strong>ï¼šæ ¹æ®ä¸åŒä»»åŠ¡é€‰æ‹©ä¸åŒçš„æŸå¤±å‡½æ•°å¹¶è®¡ç®—å…¶æ¢¯åº¦ã€‚ä¾‹å¦‚ï¼šåœ¨çº¿æ€§å›å½’ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å‡æ–¹è¯¯å·®æŸå¤±å‡½æ•°ï¼›åœ¨åˆ†ç±»ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©äº¤å‰ç†µæŸå¤±å‡½æ•°ã€‚</li>
  <li><strong>ä¼˜åŒ–å™¨</strong>ï¼šå¾—åˆ°æ¢¯åº¦ä¹‹åï¼Œæˆ‘ä»¬é€‰æ‹©æŸç§ä¼˜åŒ–å™¨æ¥æ›´æ–°æƒå€¼ã€‚</li>
  <li><strong>è¿­ä»£è®­ç»ƒ</strong>ï¼šæœ‰äº†æ•°æ®ã€æ¨¡å‹ã€æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œè¿­ä»£è®­ç»ƒäº†ã€‚</li>
</ol>

<p><strong>ä»£ç ç¤ºä¾‹</strong>ï¼š</p>

<center><video width="80%" controls="">
  <source src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-10-untitiled-1.mp4" type="video/mp4" />
</video></center>

<p><br /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">torch</span><span class="p">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># ============================== Step 1/5: ç”Ÿæˆæ•°æ® ===================================
</span><span class="n">sample_nums</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">mean_value</span> <span class="o">=</span> <span class="mf">1.7</span>
<span class="n">bias</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">n_data</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sample_nums</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mean_value</span> <span class="o">*</span> <span class="n">n_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">bias</span>    <span class="c1"># ç±»åˆ«0 æ•°æ® shape=(100, 2)
</span><span class="n">y0</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sample_nums</span><span class="p">)</span>                       <span class="c1"># ç±»åˆ«0 æ ‡ç­¾ shape=(100, 1)
</span><span class="n">x1</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="o">-</span><span class="n">mean_value</span> <span class="o">*</span> <span class="n">n_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">bias</span>   <span class="c1"># ç±»åˆ«1 æ•°æ® shape=(100, 2)
</span><span class="n">y1</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sample_nums</span><span class="p">)</span>                        <span class="c1"># ç±»åˆ«1 æ ‡ç­¾ shape=(100, 1)
</span><span class="n">train_x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">train_y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">((</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>


<span class="c1"># ============================== Step 2/5: é€‰æ‹©æ¨¡å‹ ===================================
</span><span class="k">class</span> <span class="nc">LR</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LR</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sigmoid</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>


<span class="n">lr_net</span> <span class="o">=</span> <span class="n">LR</span><span class="p">()</span>   <span class="c1"># å®ä¾‹åŒ–é€»è¾‘å›å½’æ¨¡å‹
</span>
<span class="c1"># ============================== Step 3/5: é€‰æ‹©æŸå¤±å‡½æ•° ================================
</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">BCELoss</span><span class="p">()</span>  <span class="c1"># äºŒåˆ†ç±»äº¤å‰ç†µæŸå¤± Binary Cross Entropy Loss
</span>
<span class="c1"># ============================== Step 4/5: é€‰æ‹©ä¼˜åŒ–å™¨ ==================================
</span><span class="n">lr</span> <span class="o">=</span> <span class="mf">0.01</span>   <span class="c1"># å­¦ä¹ ç‡
</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">lr_net</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>    <span class="c1"># éšæœºæ¢¯åº¦ä¸‹é™
</span>
<span class="c1"># ============================== Step 5/5: æ¨¡å‹è®­ç»ƒ ====================================
</span><span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>

    <span class="c1"># å‰å‘ä¼ æ’­
</span>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">lr_net</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>

    <span class="c1"># è®¡ç®— loss
</span>    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">y_pred</span><span class="p">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">train_y</span><span class="p">)</span>

    <span class="c1"># åå‘ä¼ æ’­
</span>    <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="c1"># æ›´æ–°å‚æ•°
</span>    <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># ç»˜å›¾
</span>    <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">.</span><span class="n">ge</span><span class="p">(</span><span class="mf">0.5</span><span class="p">).</span><span class="nb">float</span><span class="p">().</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># ä»¥ 0.5 ä¸ºé˜ˆå€¼è¿›è¡Œåˆ†ç±»
</span>        <span class="n">correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="n">train_y</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span>   <span class="c1"># è®¡ç®—æ­£ç¡®é¢„æµ‹çš„æ ·æœ¬ä¸ªæ•°
</span>        <span class="n">acc</span> <span class="o">=</span> <span class="n">correct</span><span class="p">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="n">train_y</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># è®¡ç®—åˆ†ç±»å‡†ç¡®ç‡
</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x0</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">()[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">()[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s">'r'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'class 0'</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">()[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x1</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">()[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s">'b'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'class 1'</span><span class="p">)</span>

        <span class="n">w0</span><span class="p">,</span> <span class="n">w1</span> <span class="o">=</span> <span class="n">lr_net</span><span class="p">.</span><span class="n">features</span><span class="p">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">w0</span><span class="p">,</span> <span class="n">w1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w0</span><span class="p">.</span><span class="n">item</span><span class="p">()),</span> <span class="nb">float</span><span class="p">(</span><span class="n">w1</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">plot_b</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lr_net</span><span class="p">.</span><span class="n">features</span><span class="p">.</span><span class="n">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">item</span><span class="p">())</span>
        <span class="n">plot_x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">plot_y</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">w0</span> <span class="o">*</span> <span class="n">plot_x</span> <span class="o">-</span> <span class="n">plot_b</span><span class="p">)</span> <span class="o">/</span> <span class="n">w1</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_x</span><span class="p">,</span> <span class="n">plot_y</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">'Loss=%.4f'</span> <span class="o">%</span> <span class="n">loss</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s">'size'</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s">'color'</span><span class="p">:</span> <span class="s">'red'</span><span class="p">})</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Iteration: {}</span><span class="se">\n</span><span class="s">w0:{:.2f} w1:{:.2f} b:{:.2f} accuracy:{:.2%}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">plot_b</span><span class="p">,</span> <span class="n">acc</span><span class="p">))</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">acc</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">:</span>
            <span class="k">break</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="3-æ€»ç»“">3. æ€»ç»“</h2>

<p>æœ¬èŠ‚è¯¾ä»‹ç»äº† PyTorch è‡ªåŠ¨æ±‚å¯¼ç³»ç»Ÿä¸­çš„ <code class="language-plaintext highlighter-rouge">torch.autograd.backward</code> å’Œ <code class="language-plaintext highlighter-rouge">torch.autograd.grad</code> è¿™ä¸¤ä¸ªå¸¸ç”¨æ–¹æ³•ï¼Œå¹¶æ¼”ç¤ºäº†ä¸€é˜¶ã€äºŒé˜¶å¯¼æ•°çš„æ±‚å¯¼è¿‡ç¨‹ï¼›ç†è§£äº†è‡ªåŠ¨æ±‚å¯¼ç³»ç»Ÿï¼Œä»¥åŠæ•°æ®è½½ä½“ â€”â€” å¼ é‡ï¼Œå‰å‘ä¼ æ’­æ„å»ºè®¡ç®—å›¾ï¼Œè®¡ç®—å›¾æ±‚å–æ¢¯åº¦è¿‡ç¨‹ã€‚æœ‰äº†è¿™äº›çŸ¥è¯†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æ­£å¼è®­ç»ƒæœºå™¨å­¦ä¹ æ¨¡å‹ã€‚è¿™é‡Œé€šè¿‡æ¼”ç¤ºé€»è¾‘å›å½’æ¨¡å‹çš„è®­ç»ƒï¼Œå­¦ä¹ äº†æœºå™¨å­¦ä¹ å›å½’æ¨¡å‹çš„äº”å¤§æ¨¡å—ï¼šæ•°æ®ã€æ¨¡å‹ã€æŸå¤±å‡½æ•°ã€ä¼˜åŒ–å™¨å’Œè¿­ä»£è®­ç»ƒè¿‡ç¨‹ã€‚è¿™äº”å¤§æ¨¡å—å°†æ˜¯åé¢å­¦ä¹ çš„ä¸»çº¿ã€‚</p>

<p>ä¸‹èŠ‚å†…å®¹ï¼šæ•°æ®è¯»å–æœºåˆ¶ï¼šDataloader ä¸ Dataset</p>
:ET