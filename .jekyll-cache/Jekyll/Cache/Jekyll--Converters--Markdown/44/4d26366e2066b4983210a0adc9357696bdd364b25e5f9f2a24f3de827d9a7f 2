I"¢9<h1 id="lecture-07-æ•°æ®é¢„å¤„ç†-transforms-æ¨¡å—æœºåˆ¶">Lecture 07 æ•°æ®é¢„å¤„ç† transforms æ¨¡å—æœºåˆ¶</h1>

<p>æœ¬èŠ‚è¯¾æˆ‘ä»¬å°†å­¦ä¹  PyTorch ä¸­çš„å›¾åƒé¢„å¤„ç†æ¨¡å— â€”â€” <code class="language-plaintext highlighter-rouge">transforms</code> çš„è¿è¡Œæœºåˆ¶ï¼Œä»¥åŠå¸¸ç”¨çš„æ•°æ®æ ‡å‡†åŒ–æ–¹æ³• <code class="language-plaintext highlighter-rouge">transforms.Normalize</code>ã€‚</p>

<h2 id="1-æ•°æ®é¢„å¤„ç†-transforms-æœºåˆ¶">1. æ•°æ®é¢„å¤„ç† <code class="language-plaintext highlighter-rouge">transforms</code> æœºåˆ¶</h2>

<h4 id="torchvisionè®¡ç®—æœºè§†è§‰å·¥å…·åŒ…"><code class="language-plaintext highlighter-rouge">torchvision</code>ï¼šè®¡ç®—æœºè§†è§‰å·¥å…·åŒ…</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">torchvision.transforms</code>ï¼šå¸¸ç”¨çš„å›¾åƒé¢„å¤„ç†æ–¹æ³•ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">torchvision.datasets</code>ï¼šå¸¸ç”¨æ•°æ®é›†çš„ <code class="language-plaintext highlighter-rouge">dataset</code> å®ç°ï¼Œ<code class="language-plaintext highlighter-rouge">MNIST</code>ã€<code class="language-plaintext highlighter-rouge">CIFAR-10</code>ã€<code class="language-plaintext highlighter-rouge">ImageNet</code> ç­‰ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">torchvision.model</code>ï¼šå¸¸ç”¨çš„æ¨¡å‹é¢„è®­ç»ƒï¼Œ<code class="language-plaintext highlighter-rouge">AlexNet</code>ã€<code class="language-plaintext highlighter-rouge">VGG</code>ã€<code class="language-plaintext highlighter-rouge">ResNet</code>ã€<code class="language-plaintext highlighter-rouge">GoogLeNet</code> ç­‰ã€‚</li>
</ul>

<h4 id="torchvisiontransformså¸¸ç”¨çš„å›¾åƒé¢„å¤„ç†æ–¹æ³•"><code class="language-plaintext highlighter-rouge">torchvision.transforms</code>ï¼šå¸¸ç”¨çš„å›¾åƒé¢„å¤„ç†æ–¹æ³•</h4>

<ul>
  <li>æ•°æ®ä¸­å¿ƒåŒ–</li>
  <li>æ•°æ®æ ‡å‡†åŒ–</li>
  <li>ç¼©æ”¾</li>
  <li>è£å‰ª</li>
  <li>æ—‹è½¬</li>
  <li>ç¿»è½¬</li>
  <li>å¡«å……</li>
  <li>å™ªå£°æ·»åŠ </li>
  <li>ç°åº¦å˜æ¢</li>
  <li>çº¿æ€§å˜æ¢</li>
  <li>ä»¿å°„å˜æ¢</li>
  <li>äº®åº¦ã€é¥±å’Œåº¦åŠå¯¹æ¯”åº¦å˜æ¢</li>
</ul>

<p>æˆ‘ä»¬çŸ¥é“ï¼Œæ·±åº¦å­¦ä¹ æ˜¯ç”±æ•°æ®é©±åŠ¨çš„ï¼Œè€Œæ•°æ®çš„æ•°é‡å’Œåˆ†å¸ƒå¯¹äºæ¨¡å‹çš„ä¼˜åŠ£å…·æœ‰å†³å®šæ€§ä½œç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¸€å®šçš„é¢„å¤„ç†ä»¥åŠæ•°æ®å¢å¼ºï¼Œç”¨äºæå‡æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-12-WX20201212-103652%402x.png" width="70%" /></p>

<p>ä¸Šé¢çš„ 64 å¼ å›¾ç‰‡éƒ½æ¥æºäº 1 å¼ åŸå§‹å›¾ç‰‡ï¼Œå®ƒä»¬æ˜¯ç”±åŸå§‹å›¾ç‰‡ç»è¿‡ä¸€ç³»åˆ—çš„ç¼©æ”¾ã€è£å‰ªã€å¹³ç§»ã€å˜æ¢ç­‰æ“ä½œçš„ç»„åˆç”Ÿæˆçš„ã€‚å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬è¿›è¡Œå›¾ç‰‡å¢å¼ºçš„åŸå› æ˜¯ä¸ºäº†æå‡æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ï¼šå¦‚æœæˆ‘ä»¬åœ¨æ•°æ®å¢å¼ºçš„è¿‡ç¨‹ä¸­ç”Ÿæˆäº†ä¸€äº›ä¸æµ‹è¯•æ ·æœ¬å¾ˆç›¸ä¼¼çš„å›¾ç‰‡ï¼Œé‚£ä¹ˆæ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›è‡ªç„¶å°†ä¼šå¾—åˆ°æå‡ã€‚</p>

<h4 id="ä¾‹å­äººæ°‘å¸äºŒåˆ†ç±»ä¸­çš„-transforms">ä¾‹å­ï¼šäººæ°‘å¸äºŒåˆ†ç±»ä¸­çš„ <code class="language-plaintext highlighter-rouge">transforms</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="n">transforms</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">model.lenet</span> <span class="kn">import</span> <span class="n">LeNet</span>
<span class="kn">from</span> <span class="nn">tools.my_dataset</span> <span class="kn">import</span> <span class="n">RMBDataset</span>


<span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="p">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>


<span class="n">set_seed</span><span class="p">()</span>  <span class="c1"># è®¾ç½®éšæœºç§å­
</span><span class="n">rmb_label</span> <span class="o">=</span> <span class="p">{</span><span class="s">"1"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"100"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="c1"># å‚æ•°è®¾ç½®
</span><span class="n">MAX_EPOCH</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">LR</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">log_interval</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">val_interval</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># ========================= step 1/5 æ•°æ® ===============================
</span><span class="n">split_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">".."</span><span class="p">,</span> <span class="s">".."</span><span class="p">,</span> <span class="s">"data"</span><span class="p">,</span> <span class="s">"rmb_split"</span><span class="p">)</span>
<span class="n">train_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_dir</span><span class="p">,</span> <span class="s">"train"</span><span class="p">)</span>
<span class="n">valid_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_dir</span><span class="p">,</span> <span class="s">"valid"</span><span class="p">)</span>

<span class="n">norm_mean</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">]</span>
<span class="n">norm_std</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]</span>

<span class="c1"># Compose ä¼šå°†ä¸€ç³»åˆ—çš„ transforms æ“ä½œè¿›è¡Œç»„åˆåŒ…è£…ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ
</span><span class="n">train_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="c1"># å°†å›¾åƒç¼©æ”¾åˆ° 32*32 å¤§å°
</span>    <span class="n">transforms</span><span class="p">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span>
    <span class="c1"># å¯¹å›¾åƒè¿›è¡Œéšæœºè£å‰ªï¼ˆæ•°æ®å¢å¼ºï¼‰
</span>    <span class="n">transforms</span><span class="p">.</span><span class="n">RandomCrop</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
    <span class="c1"># å°†å›¾ç‰‡è½¬æˆå¼ é‡å½¢å¼ï¼Œå¹¶è¿›è¡Œå½’ä¸€åŒ–æ“ä½œï¼ŒæŠŠåƒç´ å€¼åŒºé—´ä» [0, 255] å½’ä¸€åŒ–åˆ° [0, 1]
</span>    <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="c1"># æ•°æ®æ ‡å‡†åŒ–ï¼Œå‡å€¼ä¸º 0ï¼Œæ ‡å‡†å·®ä¸º 1ï¼šoutput = (input - mean) / std
</span>    <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">norm_mean</span><span class="p">,</span> <span class="n">norm_std</span><span class="p">),</span>
<span class="p">])</span>

<span class="c1"># æ³¨æ„ï¼šæµ‹è¯•æ•°æ®ä¸éœ€è¦è¿›è¡Œæ•°æ®å¢å¼º
</span><span class="n">valid_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">transforms</span><span class="p">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span>
    <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">norm_mean</span><span class="p">,</span> <span class="n">norm_std</span><span class="p">),</span>
<span class="p">])</span>

<span class="c1"># æ„å»º MyDataset å®ä¾‹
</span><span class="n">train_data</span> <span class="o">=</span> <span class="n">RMBDataset</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">train_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">train_transform</span><span class="p">)</span>
<span class="n">valid_data</span> <span class="o">=</span> <span class="n">RMBDataset</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">valid_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">valid_transform</span><span class="p">)</span>

<span class="c1"># æ„å»º DataLoader
</span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">valid_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">valid_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>PyTorch ä¸­çš„æ•°æ®é¢„å¤„ç†æµç¨‹å›¾</strong>ï¼š</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-11-WX20201211-190454%402x.png" width="80%" /></p>

<h2 id="2-æ•°æ®æ ‡å‡†åŒ–transformsnormalize">2. æ•°æ®æ ‡å‡†åŒ–ï¼š<code class="language-plaintext highlighter-rouge">transforms.Normalize</code></h2>

<h4 id="transformsnormalize"><code class="language-plaintext highlighter-rouge">transforms.Normalize</code></h4>

<p><strong>åŠŸèƒ½</strong>ï¼šé€ <code class="language-plaintext highlighter-rouge">channel</code> çš„å¯¹å›¾åƒè¿›è¡Œæ ‡å‡†åŒ–ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span>
    <span class="n">mean</span><span class="p">,</span>
    <span class="n">std</span><span class="p">,</span>
    <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ä¸»è¦å‚æ•°</strong>ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">mean</code>ï¼šå„é€šé“çš„å‡å€¼ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">std</code>ï¼šå„é€šé“çš„æ ‡å‡†å·®ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">inplace</code>ï¼šæ˜¯å¦åŸåœ°æ“ä½œã€‚</li>
</ul>

<p><strong>output = (input - mean) / std</strong></p>

<p><strong>ä¸ºä»€ä¹ˆè¦å¯¹æ•°æ®è¿›è¡Œæ ‡å‡†åŒ–ï¼Ÿ</strong></p>

<p>æ•°æ®æ ‡å‡†åŒ–å¯ä»¥åŠ å¿«æ¨¡å‹çš„æ”¶æ•›è¿‡ç¨‹ï¼šå› ä¸ºæ¨¡å‹åˆå§‹åŒ–é€šå¸¸æ˜¯é›¶å‡å€¼çš„ï¼Œæ‰€ä»¥é€šè¿‡æ ‡å‡†åŒ–ï¼Œæ¨¡å‹å¯ä»¥åœ¨åˆå§‹ä½ç½®é™„è¿‘æ‰¾åˆ°æœ€ä¼˜åˆ†ç•Œå¹³é¢ã€‚</p>

<h2 id="3-æ€»ç»“">3. æ€»ç»“</h2>

<p>æœ¬èŠ‚è¯¾ä»‹ç»äº†æ•°æ®çš„é¢„å¤„ç†æ¨¡å— <code class="language-plaintext highlighter-rouge">transforms</code> çš„è¿è¡Œæœºåˆ¶ï¼Œæ•°æ®åœ¨è¯»å–ä¹‹åé€šå¸¸éƒ½éœ€è¦è¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬å°ºå¯¸ç¼©æ”¾ã€è½¬æ¢å¼ é‡ã€æ•°æ®ä¸­å¿ƒåŒ–æˆ–æ ‡å‡†åŒ–ç­‰ç­‰ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">transforms</code> è¿›è¡Œçš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å­¦ä¹ äº† <code class="language-plaintext highlighter-rouge">transforms</code> çš„è¿è¡Œæœºåˆ¶ï¼Œå¹¶ä»‹ç»äº†æ•°æ®æ ‡å‡†åŒ– (<code class="language-plaintext highlighter-rouge">Normalize</code>) çš„ä½¿ç”¨åŸç†ã€‚</p>

<p>ä¸‹èŠ‚å†…å®¹ï¼štransforms æ•°æ®å¢å¼ºï¼šè£å‰ªã€ç¿»è½¬ã€æ—‹è½¬</p>
:ET