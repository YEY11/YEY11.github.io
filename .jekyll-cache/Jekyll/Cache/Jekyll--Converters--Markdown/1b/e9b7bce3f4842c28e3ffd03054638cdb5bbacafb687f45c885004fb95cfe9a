I"$¤<h1 id="lecture-18-ä¼˜åŒ–å™¨-äºŒ">Lecture 18 ä¼˜åŒ–å™¨ (äºŒ)</h1>

<p>ä¸ŠèŠ‚è¯¾æˆ‘ä»¬å­¦ä¹ äº† PyTorch ä¸­ä¼˜åŒ–å™¨çš„ä¸»è¦å±æ€§å’ŒåŸºæœ¬æ–¹æ³•ã€‚æˆ‘ä»¬çŸ¥é“ä¼˜åŒ–å™¨çš„ä¸»è¦ä½œç”¨æ˜¯ç®¡ç†å¹¶æ›´æ–°æˆ‘ä»¬çš„å‚æ•°ï¼Œå¹¶ä¸”åœ¨æ›´æ–°æ—¶ä¼šåˆ©ç”¨åˆ°å‚æ•°çš„æ¢¯åº¦ä¿¡æ¯ï¼Œç„¶åé‡‡ç”¨ä¸€å®šçš„æ›´æ–°ç­–ç•¥æ¥æ›´æ–°æˆ‘ä»¬çš„å‚æ•°ã€‚æœ¬èŠ‚è¯¾æˆ‘ä»¬å°†å­¦ä¹ ä¸€äº›æœ€å¸¸ç”¨çš„æ›´æ–°ç­–ç•¥ï¼Œä¾‹å¦‚éšæœºæ¢¯åº¦ä¸‹é™æ³•ç­‰ã€‚</p>

<h2 id="1-å­¦ä¹ ç‡">1. å­¦ä¹ ç‡</h2>

<p>æ¢¯åº¦ä¸‹é™ä¸­çš„å‚æ•°æ›´æ–°è¿‡ç¨‹ï¼š</p>

\[w_{i+1} = w_i - g(w_i)\]

<p>å…¶ä¸­ï¼Œ$g(w_i)$ è¡¨ç¤º $w_i$ çš„æ¢¯åº¦ã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è§‚å¯Ÿæ¢¯åº¦ä¸‹é™çš„è¿‡ç¨‹ä»¥åŠå¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼š</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-28-y.png" width="60%" /></p>

<p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªå‡½æ•°ï¼š</p>

\[y=f(x) = 4x^2\]

<p>å‡è®¾æˆ‘ä»¬çš„èµ·å§‹ç‚¹ä¸º $x_0=2$ï¼Œç°åœ¨æˆ‘ä»¬é‡‡ç”¨æ¢¯åº¦ä¸‹é™æ³•æ›´æ–°å‡½æ•°å€¼ $y$ ä½¿å…¶è¾¾åˆ°å…¶æå°å€¼ç‚¹ $x=0$ã€‚é¦–å…ˆæˆ‘ä»¬æ±‚å– $y$ çš„å¯¼å‡½æ•°ï¼š</p>

\[y' = f'(x) = 8x\]

<p>æˆ‘ä»¬ä»èµ·å§‹ç‚¹ $x_0=2$ å¼€å§‹æ²¿è´Ÿæ¢¯åº¦æ–¹å‘æ›´æ–° $y$ å€¼ï¼š</p>

<ul>
  <li>
    <p>$x_0 = 2, \; y_0 = 16,\; fâ€™(x_0) = 16$</p>

    <p>$x_1 = x_0 - fâ€™(x_0) = 2 -16 = -14$</p>
  </li>
  <li>
    <p>$x_1 = -14, \; y_1 = 784,\; fâ€™(x_1) = -112$</p>

    <p>$x_2 = x_1 - fâ€™(x_1) = -14 + 112 = 98,\; y_2 = 38416$</p>
  </li>
  <li>
    <p>â€¦â€¦</p>
  </li>
</ul>

<p>æˆ‘ä»¬å‘ç°ï¼Œ$y$ å€¼ä¸ä½†æ²¡æœ‰å‡å°ï¼Œåè€Œè¶Šæ¥è¶Šå¤§äº†ã€‚è¿™æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬å…ˆé€šè¿‡ä»£ç æ¥æ¼”ç¤ºè¿™ä¸€è¿‡ç¨‹ï¼Œç„¶åå†åˆ†æå¯¼è‡´è¯¥é—®é¢˜çš„åŸå› ã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆç»˜åˆ¶å‡ºå‡½æ•°æ›²çº¿ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">torch</span><span class="p">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x_t</span><span class="p">):</span>
    <span class="s">"""
    y = (2x)^2 = 4*x^2      dy/dx = 8x
    """</span>
    <span class="k">return</span> <span class="n">torch</span><span class="p">.</span><span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x_t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># init
</span><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">2.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># plot data
</span><span class="n">x_t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">x_t</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_t</span><span class="p">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">y</span><span class="p">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s">"y = 4*x^2"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"x"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">"y"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-28-y1.png" width="60%" /></p>

<p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä»£ç æ¥æ¼”ç¤ºä¸€ä¸‹å‰é¢ä¾‹å­ä¸­çš„æ¢¯åº¦ä¸‹é™è¿‡ç¨‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="n">iter_rec</span><span class="p">,</span> <span class="n">loss_rec</span><span class="p">,</span> <span class="n">x_rec</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>

<span class="n">lr</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">max_iteration</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iteration</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"Iter:{}, X:{:8}, X.grad:{:8}, loss:{:10}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">detach</span><span class="p">().</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">.</span><span class="n">grad</span><span class="p">.</span><span class="n">detach</span><span class="p">().</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">.</span><span class="n">item</span><span class="p">()))</span>

    <span class="n">x_rec</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>

    <span class="n">x</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">sub_</span><span class="p">(</span><span class="n">lr</span> <span class="o">*</span> <span class="n">x</span><span class="p">.</span><span class="n">grad</span><span class="p">)</span>    <span class="c1"># x -= x.grad  æ•°å­¦è¡¨è¾¾å¼æ„ä¹‰:  x = x - x.grad
</span>    <span class="n">x</span><span class="p">.</span><span class="n">grad</span><span class="p">.</span><span class="n">zero_</span><span class="p">()</span>

    <span class="n">iter_rec</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">loss_rec</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">iter_rec</span><span class="p">,</span> <span class="n">loss_rec</span><span class="p">,</span> <span class="s">'-ro'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"Iteration"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">"Loss value"</span><span class="p">)</span>

<span class="n">x_t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">x_t</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">x_t</span><span class="p">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">y</span><span class="p">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s">"y = 4*x^2"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">y_rec</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">i</span><span class="p">)).</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_rec</span><span class="p">]</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">x_rec</span><span class="p">,</span> <span class="n">y_rec</span><span class="p">,</span> <span class="s">'-ro'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>Iter:0, X:     2.0, X.grad:    16.0, loss:      16.0
Iter:1, X:   -14.0, X.grad:  -112.0, loss:     784.0
Iter:2, X:    98.0, X.grad:   784.0, loss:   38416.0
Iter:3, X:  -686.0, X.grad: -5488.0, loss: 1882384.0
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-28-2.png" width="60%" /></p>

<p>å·¦è¾¹æ˜¯ loss æ›²çº¿å›¾ï¼Œæ¨ªè½´æ˜¯è¿­ä»£æ¬¡æ•°ï¼Œçºµè½´æ˜¯ loss å€¼ï¼›å³è¾¹æ˜¯å‡½æ•°æ›²çº¿å›¾ï¼Œç”±äºå°ºåº¦è¿‡å¤§è¿™é‡Œæš‚æ—¶çœ‹ä¸å‡ºæ¥å‡½æ•°å½¢çŠ¶ã€‚</p>

<p>ä»æ‰“å°ä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç¬¬ 0 æ¬¡è¿­ä»£æ—¶ï¼Œ$x$ çš„åˆå§‹å€¼ä¸º $2$ï¼Œå¯¹åº”æ¢¯åº¦ä¸º $16$ï¼Œloss å€¼ä¹Ÿæ˜¯ $16$ã€‚éšç€è¿­ä»£æ¬¡æ•°çš„å¢åŠ ï¼Œæˆ‘ä»¬å‘ç° loss å€¼æ¿€å¢åˆ° $1882384$ã€‚æ‰€ä»¥ï¼Œ$y$ å¹¶æ²¡æœ‰å‡å°ï¼Œåè€Œæ˜¯æ¿€å¢çš„ï¼Œè€Œæ¢¯åº¦ä¹Ÿè¾¾åˆ°äº† $10^3$ æ•°é‡çº§ï¼Œæ‰€ä»¥å­˜åœ¨æ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜ã€‚</p>

<p>å›åˆ°å‰é¢çš„æ¢¯åº¦æ›´æ–°å…¬å¼ï¼š</p>

\[w_{i+1} = w_i - g(w_i)\]

<p>è¿™é‡Œå¯èƒ½å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç›®å‰æ˜¯ç›´æ¥å‡å»æ¢¯åº¦é¡¹ $g(w_i)$ï¼Œè€Œè¿™é‡Œå‡å»çš„æ¢¯åº¦é¡¹å¯èƒ½ç”±äºå…¶å°ºåº¦è¿‡å¤§ä»è€Œå¯¼è‡´å‚æ•°é¡¹è¶Šæ¥è¶Šå¤§ï¼Œä»è€Œå¯¼è‡´å‡½æ•°å€¼æ— æ³•é™ä½ã€‚å› æ­¤ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåœ¨æ¢¯åº¦é¡¹å‰é¢ä¹˜ä»¥ä¸€ä¸ªç³»æ•°ï¼Œç”¨äºç¼©å‡å°ºåº¦ï¼š</p>

\[w_{i+1} = w_i - \mathrm{LR}\cdot g(w_i)\]

<p>è¿™é‡Œï¼Œæˆ‘ä»¬å°†ç³»æ•° $\mathrm{LR}$ ç§°ä¸º <strong>å­¦ä¹ ç‡ (learning rate)</strong>ï¼Œå®ƒè¢«ç”¨æ¥æ§åˆ¶æ›´æ–°çš„æ­¥ä¼ã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬åœ¨ä»£ç ä¸­è°ƒæ•´å­¦ä¹ ç‡ï¼Œè§‚å¯Ÿå‡½æ•°å€¼çš„å˜åŒ–ï¼š</p>

<h5 id="mathrmlr--05">$\mathrm{LR} = 0.5$</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">lr</span> <span class="o">=</span> <span class="mf">0.5</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>Iter:0, X:     2.0, X.grad:    16.0, loss:      16.0
Iter:1, X:    -6.0, X.grad:   -48.0, loss:     144.0
Iter:2, X:    18.0, X.grad:   144.0, loss:    1296.0
Iter:3, X:   -54.0, X.grad:  -432.0, loss:   11664.0
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-28-Picture1.png" width="60%" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œloss å€¼ä»ç„¶å‘ˆæ¿€å¢è¶‹åŠ¿ï¼Œä½†æ˜¯æƒ…å†µæœ‰æ‰€ç¼“è§£ï¼Œå°ºåº¦æ¯”ä¹‹å‰å°äº†å¾ˆå¤šã€‚</p>

<h5 id="mathrmlr--02">$\mathrm{LR} = 0.2$</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">lr</span> <span class="o">=</span> <span class="mf">0.2</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>Iter:0, X:     2.0, X.grad:    16.0, loss:      16.0
Iter:1, X:-1.2000000476837158, X.grad:-9.600000381469727, loss:5.760000228881836
Iter:2, X:0.7200000286102295, X.grad:5.760000228881836, loss:2.0736000537872314
Iter:3, X:-0.4320000410079956, X.grad:-3.456000328063965, loss:0.7464961409568787
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-28-Picture1-1.png" width="60%" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨ loss å€¼å‘ˆä¸‹é™è¶‹åŠ¿ï¼ŒåŒæ—¶å³å›¾ä¹Ÿå¯ä»¥çœ‹åˆ°æ­£å¸¸çš„å‡½æ•°å›¾åƒäº†ã€‚å½“å‰å­¦ä¹ ç‡ä¸º $0.2$ï¼Œä»å³å›¾å¯ä»¥çœ‹åˆ°ï¼šåˆå§‹ç‚¹ä¸º $x=2$ï¼Œloss å€¼ä¸º $16$ï¼›ç»è¿‡ä¸€æ­¥æ›´æ–°åæ¥åˆ°ç‚¹ $x = -1.2$ï¼Œæ­¤æ—¶ loss å€¼ä¸º $5.76$ï¼›ç„¶åå†æ¬¡è¿­ä»£åæ¥åˆ° $x=0.72$ï¼Œloss å€¼ä¸º $2.07$ï¼›ç¬¬ä¸‰æ¬¡è¿­ä»£åï¼Œ$x = -0.43$ï¼Œloss å€¼ä¸º $0.75$ã€‚</p>

<p>ç°åœ¨æˆ‘ä»¬å°†å¢åŠ è¿­ä»£æ¬¡æ•°å¢åŠ åˆ° $20$ æ¬¡ï¼Œæ¥è§‚å¯Ÿå‡½æ•°æ˜¯å¦èƒ½å¤Ÿåˆ°è¾¾æå°å€¼ç‚¹ $x=0$ é™„è¿‘ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>max_iteration = 20
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>Iter:0, X:     2.0, X.grad:    16.0, loss:      16.0
Iter:1, X:-1.2000000476837158, X.grad:-9.600000381469727, loss:5.760000228881836
Iter:2, X:0.7200000286102295, X.grad:5.760000228881836, loss:2.0736000537872314
Iter:3, X:-0.4320000410079956, X.grad:-3.456000328063965, loss:0.7464961409568787
Iter:4, X:0.2592000365257263, X.grad:2.0736002922058105, loss:0.26873862743377686
Iter:5, X:-0.1555200219154358, X.grad:-1.2441601753234863, loss:0.09674590826034546
Iter:6, X:0.09331201016902924, X.grad:0.7464960813522339, loss:0.03482852503657341
Iter:7, X:-0.05598720908164978, X.grad:-0.44789767265319824, loss:0.012538270093500614
Iter:8, X:0.03359232842922211, X.grad:0.26873862743377686, loss:0.004513778258115053
Iter:9, X:-0.020155396312475204, X.grad:-0.16124317049980164, loss:0.0016249599866569042
Iter:10, X:0.012093238532543182, X.grad:0.09674590826034546, loss:0.0005849856534041464
Iter:11, X:-0.007255943492054939, X.grad:-0.058047547936439514, loss:0.000210594866075553
Iter:12, X:0.0043535660952329636, X.grad:0.03482852876186371, loss:7.581415411550552e-05
Iter:13, X:-0.0026121395640075207, X.grad:-0.020897116512060165, loss:2.729309198912233e-05
Iter:14, X:0.001567283645272255, X.grad:0.01253826916217804, loss:9.825512279348914e-06
Iter:15, X:-0.0009403701405972242, X.grad:-0.007522961124777794, loss:3.537184056767728e-06
Iter:16, X:0.0005642221076413989, X.grad:0.004513776861131191, loss:1.2733863741232199e-06
Iter:17, X:-0.00033853325294330716, X.grad:-0.0027082660235464573, loss:4.584190662626497e-07
Iter:18, X:0.00020311994012445211, X.grad:0.001624959520995617, loss:1.6503084054875217e-07
Iter:19, X:-0.00012187196989543736, X.grad:-0.0009749757591634989, loss:5.941110714502429e-08
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-28-142219.jpg" width="60%" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿­ä»£ $5$ åˆ° $7$ æ¬¡ä¹‹åï¼Œå·¦å›¾ä¸­çš„ loss æ›²çº¿å·²ç»è¶‹è¿‘äºé›¶äº†ï¼Œå³å·²ç»è¾¾åˆ°æ”¶æ•›ï¼ŒåŒæ—¶å³å›¾å¯ä»¥çœ‹åˆ°æœ€åå‡ æ¬¡è¿­ä»£éƒ½åœ¨æå°å€¼ç‚¹é™„è¿‘æ¥å›æŒ¯åŠ¨ï¼Œè¿™è¯´æ˜æˆ‘ä»¬çš„å­¦ä¹ ç‡æ˜¯æ¯”è¾ƒåˆç†çš„ã€‚</p>

<h5 id="mathrmlr--01">$\mathrm{LR} = 0.1$</h5>

<p>é‚£ä¹ˆï¼Œæ˜¯å¦è¿˜å­˜åœ¨æ›´å¥½çš„å­¦ä¹ ç‡å‘¢ï¼Ÿæˆ‘ä»¬å°è¯•å°†å­¦ä¹ ç‡è°ƒæ•´åˆ° $0.1$ï¼Œè§‚å¯Ÿå‡½æ•°å€¼çš„å˜åŒ–ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">lr</span> <span class="o">=</span> <span class="mf">0.1</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>Iter:0, X:     2.0, X.grad:    16.0, loss:      16.0
Iter:1, X:0.3999999761581421, X.grad:3.1999998092651367, loss:0.6399999260902405
Iter:2, X:0.07999998331069946, X.grad:0.6399998664855957, loss:0.025599990040063858
Iter:3, X:0.015999995172023773, X.grad:0.12799996137619019, loss:0.0010239994153380394
Iter:4, X:0.0031999992206692696, X.grad:0.025599993765354156, loss:4.0959981561172754e-05
Iter:5, X:0.0006399997510015965, X.grad:0.005119998008012772, loss:1.6383987713197712e-06
Iter:6, X:0.00012799992691725492, X.grad:0.0010239994153380394, loss:6.553592868385749e-08
Iter:7, X:2.5599983928259462e-05, X.grad:0.0002047998714260757, loss:2.621436623329032e-09
Iter:8, X:5.1199967856518924e-06, X.grad:4.095997428521514e-05, loss:1.0485746992916489e-10
Iter:9, X:1.0239991752314381e-06, X.grad:8.191993401851505e-06, loss:4.194297253262702e-12
Iter:10, X:2.047998464149714e-07, X.grad:1.6383987713197712e-06, loss:1.6777191073034936e-13
Iter:11, X:4.095996075648145e-08, X.grad:3.276796860518516e-07, loss:6.710873481539318e-15
Iter:12, X:8.191992861839026e-09, X.grad:6.553594289471221e-08, loss:2.6843498478959363e-16
Iter:13, X:1.6383983059142793e-09, X.grad:1.3107186447314234e-08, loss:1.0737395785076275e-17
Iter:14, X:3.2767966118285585e-10, X.grad:2.621437289462847e-09, loss:4.294958520825663e-19
Iter:15, X:6.55359377876863e-11, X.grad:5.242875023014903e-10, loss:1.7179836926736008e-20
Iter:16, X:1.3107185475869088e-11, X.grad:1.048574838069527e-10, loss:6.871932690625968e-22
Iter:17, X:2.62143692170147e-12, X.grad:2.097149537361176e-11, loss:2.748772571379408e-23
Iter:18, X:5.242874277083809e-13, X.grad:4.194299421667047e-12, loss:1.0995092021011623e-24
Iter:19, X:1.0485747469965445e-13, X.grad:8.388597975972356e-13, loss:4.398036056521599e-26
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-28-142954.jpg" width="60%" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå½“å­¦ä¹ ç‡è°ƒæ•´ä¸º $0.1$ æ—¶ï¼Œloss æ›²çº¿ä¹Ÿå¯ä»¥å¿«é€Ÿæ”¶æ•›ã€‚</p>

<h5 id="mathrmlr--0125">$\mathrm{LR} = 0.125$</h5>

<p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰èƒ½å¤Ÿä½¿å¾—æ”¶æ•›é€Ÿåº¦æ›´å¿«çš„å­¦ä¹ ç‡å‘¢ï¼Ÿæˆ‘ä»¬å°è¯•å°†å­¦ä¹ ç‡è®¾ç½®ä¸º $0.125$ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">lr</span> <span class="o">=</span> <span class="mf">0.125</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>Iter:0, X:     2.0, X.grad:    16.0, loss:      16.0
Iter:1, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:2, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:3, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:4, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:5, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:6, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:7, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:8, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:9, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:10, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:11, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:12, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:13, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:14, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:15, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:16, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:17, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:18, X:     0.0, X.grad:     0.0, loss:       0.0
Iter:19, X:     0.0, X.grad:     0.0, loss:       0.0
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-28-143346.jpg" width="60%" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå½“å­¦ä¹ ç‡ä¸º $0.125$ æ—¶ï¼Œä»…ç»è¿‡ä¸€æ¬¡è¿­ä»£ï¼Œloss å€¼å°±å·²ç»è¾¾åˆ°æ”¶æ•›ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ª $0.125$ æ˜¯å¦‚ä½•å¾—åˆ°çš„å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬ä¸çŸ¥é“å‡½æ•°è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬æ˜¯æ²¡åŠæ³•ç›´æ¥è®¡ç®—å‡ºæœ€ä½³å­¦ä¹ ç‡çš„ã€‚æ‰€ä»¥ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šå°è¯•æ€§åœ°è®¾ç½®ä¸€ç³»åˆ—çš„å­¦ä¹ ç‡ï¼Œä»¥æ‰¾åˆ°æœ€ä½³å­¦ä¹ ç‡ã€‚ä¸‹é¢æˆ‘ä»¬æ¥è§‚å¯Ÿè®¾ç½®å¤šä¸ªå­¦ä¹ ç‡æ—¶çš„ loss å˜åŒ–æƒ…å†µã€‚</p>

<h5 id="è®¾ç½®å¤šä¸ªå­¦ä¹ ç‡">è®¾ç½®å¤šä¸ªå­¦ä¹ ç‡</h5>

<p>æˆ‘ä»¬åœ¨ $0.01$ åˆ° $0.5$ ä¹‹é—´çº¿æ€§åœ°è®¾ç½® 10 ä¸ªå­¦ä¹ ç‡ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="n">iteration</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">num_lr</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">lr_min</span><span class="p">,</span> <span class="n">lr_max</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span>

<span class="n">lr_list</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lr_min</span><span class="p">,</span> <span class="n">lr_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_lr</span><span class="p">).</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">loss_rec</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lr_list</span><span class="p">))]</span>
<span class="n">iter_rec</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lr_list</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">2.</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iteration</span><span class="p">):</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">x</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">sub_</span><span class="p">(</span><span class="n">lr</span> <span class="o">*</span> <span class="n">x</span><span class="p">.</span><span class="n">grad</span><span class="p">)</span>  <span class="c1"># x.data -= x.grad
</span>        <span class="n">x</span><span class="p">.</span><span class="n">grad</span><span class="p">.</span><span class="n">zero_</span><span class="p">()</span>

        <span class="n">loss_rec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loss_r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loss_rec</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loss_r</span><span class="p">)),</span> <span class="n">loss_r</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"LR: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">lr_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Iterations'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Loss value'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-29-031334.jpg" width="60%" /></p>

<p>æˆ‘ä»¬å¾—åˆ°äº† 10 ä¸ªä¸åŒçš„ loss æ›²çº¿ï¼Œæ¨ªè½´è¡¨ç¤ºè¿­ä»£æ¬¡æ•°ï¼Œçºµè½´è¡¨ç¤º loss å€¼ã€‚å¯ä»¥çœ‹åˆ°ï¼Œloss å€¼çš„å°ºåº¦æ˜¯ $10^{38}$ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ•°å­—ï¼Œä¸æ˜¯æˆ‘ä»¬æ‰€å¸Œæœ›çš„ã€‚å¯ä»¥çœ‹åˆ°ï¼Œä» $0.5$ åˆ° $0.337$ è¿™ 4 æ¡æ›²çº¿éƒ½å­˜åœ¨æ¿€å¢è¶‹åŠ¿ã€‚è¿™è¡¨æ˜æˆ‘ä»¬çš„å­¦ä¹ ç‡ä¸Šé™è®¾ç½®å¾—è¿‡å¤§äº†ï¼Œå¯¼è‡´äº† loss æ¿€å¢å’Œæ¢¯åº¦çˆ†ç‚¸ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ç‡ä¸Šé™æ”¹ä¸º $0.3$ï¼Œè§‚å¯Ÿä¸€ä¸‹ loss æ›²çº¿çš„å˜åŒ–æƒ…å†µï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">lr_min</span><span class="p">,</span> <span class="n">lr_max</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-29-032014.jpg" width="60%" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å­¦ä¹ ç‡å–åˆ°æœ€å¤§å€¼ $0.3$ æ—¶ï¼Œloss å€¼å°ºåº¦ä¸º $10^{30}$ï¼Œç›¸æ¯”ä¹‹å‰ $10^{38}$ æœ‰æ‰€ä¸‹é™ï¼Œä½†æ˜¯ loss å€¼ä»ç„¶å­˜åœ¨æ¿€å¢ç°è±¡ã€‚ä¸‹é¢æˆ‘ä»¬å°†å­¦ä¹ ç‡ä¸Šé™æ”¹ä¸º $0.2$ï¼Œè§‚å¯Ÿä¸€ä¸‹ loss æ›²çº¿çš„å˜åŒ–æƒ…å†µï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">lr_min</span><span class="p">,</span> <span class="n">lr_max</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.2</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-29-032318.jpg" width="60%" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨çš„ 10 æ¡æ›²çº¿éƒ½å‘ˆç°ä¸‹é™è¶‹åŠ¿ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„ã€‚æœ€å³è¾¹çš„è“è‰²æ›²çº¿å¯¹åº”æœ€å°å­¦ä¹ ç‡ $0.01$ï¼Œå…¶æ”¶æ•›é€Ÿåº¦ä¹Ÿæ˜¯æœ€æ…¢çš„ï¼Œå¤§çº¦ä¸º 30 æ¬¡ã€‚å³æ•°ç¬¬äºŒæ¡æ©™è‰²æ›²çº¿å¯¹åº”ç¬¬äºŒå°çš„å­¦ä¹ ç‡ $0.03$ï¼Œå…¶æ”¶æ•›é€Ÿåº¦ä¹Ÿæ˜¯ç¬¬äºŒæ…¢çš„ã€‚é‚£ä¹ˆï¼Œæ˜¯å¦å­¦ä¹ ç‡è¶Šå¤§ï¼Œæ”¶æ•›è¶Šå¿«å‘¢ï¼Ÿæˆ‘ä»¬çœ‹åˆ°ï¼Œæ”¶æ•›æœ€å¿«çš„æ›²çº¿å¹¶ä¸æ˜¯æœ€å¤§å­¦ä¹ ç‡ $0.2$ å¯¹åº”çš„é’è‰²æ›²çº¿ï¼Œè€Œæ˜¯å­¦ä¹ ç‡ $0.136$ å¯¹åº”çš„ç²‰è‰²æ›²çº¿ã€‚å›å¿†ä¸€ä¸‹ï¼Œå‰é¢æˆ‘ä»¬æåˆ°çš„æœ€ä½³å­¦ä¹ ç‡ $0.125$ï¼Œè¿™äº›å­¦ä¹ ç‡ä¸­ä¸å…¶è·ç¦»æœ€è¿‘çš„æ­£æ˜¯ $0.136$ã€‚å› æ­¤ï¼Œå½“å­¦ä¹ ç‡è·ç¦»æœ€ä¼˜å­¦ä¹ ç‡æœ€è¿‘æ—¶ï¼Œæ”¶æ•›é€Ÿåº¦æœ€å¿«ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰ä¸Šå¸è§†è§’ï¼Œæ— æ³•æå‰çŸ¥é“æœ€ä¼˜å­¦ä¹ ç‡ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šå¸¸ä¼šè®¾ç½®è¯¸å¦‚ $0.01$ è¿™æ ·éå¸¸å°çš„å­¦ä¹ ç‡ï¼Œä»¥è¾¾åˆ°æ”¶æ•›æ•ˆæœï¼Œå…¶ä»£ä»·å°±æ˜¯æ”¶æ•›é€Ÿåº¦å¯èƒ½ä¼šè¾ƒæ…¢ã€‚</p>

<p>ç»¼ä¸Šæ‰€è¿°ï¼Œè®¾ç½®å­¦ä¹ ç‡æ—¶ä¸èƒ½è¿‡å¤§ï¼Œå¦åˆ™å°†å¯¼è‡´ loss å€¼æ¿€å¢ï¼Œå¹¶ä¸”å¼•å‘æ¢¯åº¦çˆ†ç‚¸ï¼›åŒæ—¶ä¹Ÿä¸èƒ½è¿‡å°ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ”¶æ•›é€Ÿåº¦è¿‡æ…¢ï¼Œæ—¶é—´æˆæœ¬å¢åŠ ã€‚é€šè¿‡å°†å­¦ä¹ ç‡è®¾ç½®ä¸º $0.01$ è¿™æ ·è¾ƒå°çš„å€¼ï¼Œå°±å¯ä»¥ä½¿å¾—æˆ‘ä»¬çš„ loss å€¼é€æ¸ä¸‹é™ç›´åˆ°æ”¶æ•›ã€‚</p>

<h2 id="2-åŠ¨é‡">2. åŠ¨é‡</h2>

<p><strong>Momentum (åŠ¨é‡/å†²é‡)</strong>ï¼šç»“åˆå½“å‰æ¢¯åº¦ä¸ä¸Šä¸€æ¬¡æ›´æ–°ä¿¡æ¯ï¼Œç”¨äºå½“å‰æ›´æ–°ã€‚</p>

<p><strong>æŒ‡æ•°åŠ æƒæ›´æ–°</strong>ï¼šæ±‚å–å½“å‰æ—¶åˆ»çš„å¹³å‡å€¼ï¼Œå¸¸ç”¨äºæ—¶é—´åºåˆ—åˆ†æã€‚å¯¹äºé‚£äº›è·ç¦»å½“å‰æ—¶åˆ»è¶Šè¿‘çš„å‚æ•°å€¼ï¼Œå®ƒä»¬çš„å‚è€ƒæ€§è¶Šå¤§ï¼Œæ‰€å çš„æƒé‡ä¹Ÿè¶Šå¤§ï¼Œè€Œæƒé‡éšæ—¶é—´é—´éš”çš„å¢å¤§å‘ˆæŒ‡æ•°ä¸‹é™ã€‚</p>

\[v_t = \beta \cdot v_{t-1} + (1-\beta) \cdot \theta_t\]

<p>å…¶ä¸­ï¼Œ$v_t$ æ˜¯å½“å‰æ—¶åˆ»çš„å¹³å‡å€¼ï¼Œ$v_{t-1}$ æ˜¯å‰ä¸€ä¸ªæ—¶åˆ»çš„å¹³å‡å€¼ï¼Œ$\theta_t$ æ˜¯å½“å‰æ—¶åˆ»çš„å‚æ•°å€¼ï¼Œ$\beta$ æ˜¯æƒé‡å‚æ•°ã€‚</p>

<p><strong>ä¾‹å­</strong>ï¼š</p>

<p>æ•°æ®é›†ä¸ºè¿ç»­å¤šå¤©çš„æ¸©åº¦å€¼ï¼š</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2021-01-01-temp.png" width="50%" /></p>

<p>å‡è®¾ç°åœ¨æˆ‘ä»¬è¦æ±‚å–ç¬¬ 100 å¤©çš„æ¸©åº¦å¹³å‡å€¼ï¼š</p>

\[\begin{aligned}
v_{100} &amp;= \beta \cdot v_{99} + (1-\beta) \cdot \theta_{100} \\[2ex]
&amp;= (1-\beta) \cdot \theta_{100} + \beta \cdot (\beta \cdot v_{98} + (1-\beta) \cdot \theta_{99}) \\[2ex]
&amp;= (1-\beta) \cdot \theta_{100} + (1-\beta) \cdot \beta \cdot \theta_{99} + \beta^2 \cdot v_{98} \\[2ex]
&amp;= (1-\beta) \cdot \theta_{100} + (1-\beta) \cdot \beta \cdot \theta_{99} + (1-\beta) \cdot \beta^2 \cdot \theta_{98} + \beta^3 \cdot v_{97} \\[2ex]
&amp;= \cdots \\[2ex]
&amp;= \sum_{i=0}^{100} (1-\beta) \cdot \beta^i \cdot \theta_{n-i}
\end{aligned}\]

<p><strong>ä»£ç ç¤ºä¾‹</strong>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">torch</span><span class="p">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">exp_w_func</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">time_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">power</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span> <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">time_list</span><span class="p">]</span>


<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">num_point</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">time_list</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_point</span><span class="p">).</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">weights</span> <span class="o">=</span> <span class="n">exp_w_func</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">time_list</span><span class="p">)</span>    <span class="c1"># æŒ‡æ•°æƒé‡
</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_list</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="s">'-ro'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Beta: {}</span><span class="se">\n</span><span class="s">y = B^t * (1-B)"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"time"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">"weight"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"exponentially weighted average"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>0.9999734386011124
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2021-01-01-023454.jpg" width="60%" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæƒé‡éšæ—¶é—´é—´éš”çš„å¢åŠ å‘ˆæŒ‡æ•°ä¸‹é™ã€‚ä¸‹é¢æˆ‘ä»¬å°è¯•è°ƒæ•´è¶…å‚æ•° $\beta$ çš„å€¼ï¼Œæ¥è§‚å¯Ÿä¸€ä¸‹æƒé‡çš„å˜åŒ–ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1"># å¤šä¸ªæƒé‡æ›²çº¿
</span><span class="n">beta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>
<span class="n">w_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_w_func</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">time_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">beta_list</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">w_list</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_list</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Beta: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">beta_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"time"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">"weight"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2021-01-01-024053.jpg" width="60%" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œéšç€æƒé‡å‚æ•° $\beta$ çš„å¢å¤§ï¼Œæƒé‡æ›²çº¿é€æ¸å˜å¾—å¹³ç¼“ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶ç†è§£ä¸ºæŸç§è®°å¿†å‘¨æœŸï¼Œ$\beta$ å€¼è¶Šå°ï¼Œå…¶è®°å¿†å‘¨æœŸè¶ŠçŸ­ï¼Œå¯¹äºè¾ƒé•¿æ—¶é—´é—´éš”å‚æ•°çš„å…³æ³¨è¶Šå°‘ã€‚é€šå¸¸æˆ‘ä»¬å°† $\beta$ è®¾ç½®ä¸º $0.9$ï¼Œå³æƒé‡æ›²çº¿å°†æ›´åŠ å…³æ³¨è·ç¦»å½“å‰æ—¶é—´ $1/(1-\beta) = 10$ å¤©ä»¥å†…çš„æ•°æ®ã€‚</p>

<p>æˆ‘ä»¬å·²ç»äº†è§£äº†æŒ‡æ•°åŠ æƒå¹³å‡ä¸­çš„æƒé‡å‚æ•° $\beta$ï¼Œåœ¨æ¢¯åº¦ä¸‹é™ä¸­å®ƒå¯¹åº”çš„å°±æ˜¯ momentum ç³»æ•°ã€‚</p>

<p><strong>æ¢¯åº¦ä¸‹é™</strong>ï¼š</p>

\[w_{i+1} = w_i - \mathrm{LR} \cdot g(w_i)\]

<p><strong>PyTorch ä¸­çš„æ›´æ–°å…¬å¼</strong>ï¼š</p>

\[v_i = m \cdot v_{i-1} + g(w_i)\]

\[w_{i+1} = w_i - \mathrm{LR} \cdot v_i\]

<p>å…¶ä¸­ï¼Œ$w_{i+1}$ æ˜¯ç¬¬ $i+1$ æ¬¡æ›´æ–°çš„å‚æ•°ï¼Œ$\mathrm{LR}$ æ˜¯å­¦ä¹ ç‡ï¼Œ$g(w_i)$ æ˜¯ $w_i$ çš„æ¢¯åº¦ï¼Œ$v_i$ æ˜¯æ›´æ–°é‡ï¼Œ$m$ æ˜¯ momentum ç³»æ•°ã€‚</p>

<p>ä¾‹å¦‚ï¼š</p>

\[\begin{aligned}
v_{100} &amp;= m \cdot v_{99} + g(w_{100}) \\[2ex]
&amp;= g(w_{100}) + m \cdot (m \cdot v_{98} + g(w_{99})) \\[2ex]
&amp;= g(w_{100}) + m \cdot g(w_{99}) + m^2 \cdot v_{98} \\[2ex]
&amp;= g(w_{100}) + m \cdot g(w_{99}) + m^2 \cdot g(w_{98}) + m^3 \cdot v_{97} \\[2ex]
&amp;= \cdots
\end{aligned}\]

<p>å¯ä»¥çœ‹åˆ°ï¼Œmomentum ç³»æ•°çš„ä½œç”¨å°±æ˜¯å½“å‰æ›´æ–°ä¸ä»…è€ƒè™‘äº†å½“å‰çš„æ¢¯åº¦ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿè€ƒè™‘äº†ä¹‹å‰å‡ æ¬¡çš„æ¢¯åº¦ä¿¡æ¯ã€‚ç”±äº momentum ç³»æ•°å–å€¼åœ¨ $[0,1]$ï¼Œæ‰€ä»¥æ—¶é—´é—´éš”è¶Šé•¿çš„æ¢¯åº¦ä¿¡æ¯æ‰€å æƒé‡è¶Šä½ã€‚</p>

<p><strong>ä»£ç ç¤ºä¾‹</strong>ï¼š</p>

<p>ä¸‹é¢æˆ‘ä»¬è®¾ç½®ä¸¤ä¸ªå­¦ä¹ ç‡ï¼Œç”¨</p>

<p>ä¸‹èŠ‚å†…å®¹ï¼šä¼˜åŒ–å™¨ (äºŒ)</p>
:ET