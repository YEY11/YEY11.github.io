I"ÑP<h1 id="lecture-13-nn-ç½‘ç»œå±‚æ± åŒ–å±‚å…¨è¿æ¥å±‚å’Œæ¿€æ´»å‡½æ•°å±‚">Lecture 13 nn ç½‘ç»œå±‚ï¼šæ± åŒ–å±‚ã€å…¨è¿æ¥å±‚å’Œæ¿€æ´»å‡½æ•°å±‚</h1>

<p>ä¸ŠèŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ç½‘ç»œå±‚ä¸­çš„å·ç§¯å±‚ã€‚æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†ç»§ç»­å­¦ä¹ å…¶ä»–å‡ ç§ç½‘ç»œå±‚ï¼šæ± åŒ–å±‚ã€çº¿æ€§å±‚å’Œæ¿€æ´»å‡½æ•°å±‚ã€‚</p>

<h2 id="1-æ± åŒ–å±‚">1. æ± åŒ–å±‚</h2>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-16-mp.gif" width="60%" /></p>

<p><strong>æ± åŒ–è¿ç®— (Pooling)</strong>ï¼šå¯¹ä¿¡å·è¿›è¡Œ <strong>â€œæ”¶é›†â€</strong> å¹¶ <strong>â€œæ€»ç»“â€</strong>ï¼Œç±»ä¼¼æ°´æ± æ”¶é›†æ°´èµ„æºï¼Œå› è€Œå¾—åæ± åŒ–å±‚ã€‚</p>

<ul>
  <li><strong>â€œæ”¶é›†â€</strong>ï¼šå¤šå˜å°‘ã€‚</li>
  <li><strong>â€œæ€»ç»“â€</strong>ï¼šæœ€å¤§å€¼/å¹³å‡å€¼ã€‚</li>
</ul>

<p><strong>æœ€å¤§æ± åŒ– vs. å¹³å‡æ± åŒ–</strong>ï¼š</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-16-Illustration-of-Max-Pooling-and-Average-Pooling-Figure-2-above-shows-an-example-of-max.png" width="60%" /></p>

<h4 id="nnmaxpool2d"><code class="language-plaintext highlighter-rouge">nn.MaxPool2d</code></h4>

<p><strong>åŠŸèƒ½</strong>ï¼šå¯¹äºŒç»´ä¿¡å·ï¼ˆå›¾åƒï¼‰è¿›è¡Œæœ€å¤§å€¼æ± åŒ–ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">nn</span><span class="p">.</span><span class="n">MaxPool2d</span><span class="p">(</span>
    <span class="n">kernel_size</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">dilation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">return_indices</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">ceil_mode</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ä¸»è¦å‚æ•°</strong>ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">kernel_size</code>ï¼šæ± åŒ–æ ¸å°ºå¯¸ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">stride</code>ï¼šæ­¥é•¿ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">padding</code>ï¼šå¡«å……ä¸ªæ•°ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">dilation</code>ï¼šæ± åŒ–æ ¸é—´éš”å¤§å°ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">ceil_mode</code>ï¼šå°ºå¯¸æ˜¯å¦å‘ä¸Šå–æ•´ã€‚ç”¨äºè®¡ç®—è¾“å‡ºç‰¹å¾å›¾å°ºå¯¸ï¼Œé»˜è®¤è®¾ç½®ä¸ºå‘ä¸‹å–æ•´ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">return_indices</code>ï¼šè®°å½•æ± åŒ–åƒç´ ç´¢å¼•ã€‚é€šå¸¸åœ¨æœ€å¤§å€¼åæ± åŒ–ä¸Šé‡‡æ ·æ—¶ä½¿ç”¨ã€‚</li>
</ul>

<p><strong>æœ€å¤§å€¼åæ± åŒ–ï¼š</strong></p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-16-111500.png" width="80%" /></p>

<p>æ—©æœŸçš„è‡ªç¼–ç å™¨å’Œå›¾åƒåˆ†å‰²ä»»åŠ¡ä¸­éƒ½ä¼šæ¶‰åŠä¸€ä¸ªä¸Šé‡‡æ ·çš„æ“ä½œï¼Œå½“æ—¶æ™®éé‡‡ç”¨çš„æ–¹æ³•æ˜¯æœ€å¤§å€¼åæ± åŒ–ä¸Šé‡‡æ ·ã€‚ä¸Šå›¾å·¦åŠéƒ¨åˆ†æ˜¯æœ€å¤§æ± åŒ–è¿‡ç¨‹ï¼ŒåŸå§‹ $4\times 4$ çš„å›¾åƒç»è¿‡æœ€å¤§æ± åŒ–åå¾—åˆ°ä¸€ä¸ª $2\times 2$ çš„ä¸‹é‡‡æ ·å›¾åƒï¼Œç„¶åç»è¿‡ä¸€ç³»åˆ—çš„ç½‘ç»œå±‚ä¹‹åï¼Œè¿›å…¥ä¸Šå›¾å³åŠéƒ¨åˆ†çš„ä¸Šé‡‡æ ·è§£ç å™¨ï¼Œå³å°†ä¸€ä¸ªå°ºå¯¸è¾ƒå°çš„å›¾åƒç»è¿‡ä¸Šé‡‡æ ·å¾—åˆ°ä¸€ä¸ªå°ºå¯¸è¾ƒå¤§çš„å›¾åƒã€‚æ­¤æ—¶ï¼Œæ¶‰åŠåˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šæˆ‘ä»¬åº”è¯¥å°†åƒç´ å€¼æ”¾åˆ°ä»€ä¹ˆä½ç½®ã€‚ä¾‹å¦‚ï¼šå³è¾¹ $2\times 2$ å›¾åƒä¸­çš„å·¦ä¸Šè§’çš„ $3$ åº”å½“æ”¾å…¥æœ€ç»ˆ $4\times 4$ å›¾åƒä¸­çš„å·¦ä¸Šéƒ¨åˆ†çš„ $4$ ä¸ªåƒç´ ä¸­çš„å“ªä¸€ä¸ªï¼Ÿè¿™æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ä¹‹å‰æœ€å¤§æ± åŒ–è¿‡ç¨‹ä¸­è®°å½•çš„æ± åŒ–åƒç´ ç´¢å¼•ï¼Œå°† $3$ æ”¾å…¥ä¹‹å‰åŸå§‹ $4\times 4$ å›¾åƒä¸­å·¦ä¸Šè§’çš„ $4$ ä¸ªåƒç´ ä¸­æœ€å¤§å€¼å¯¹åº”çš„ä½ç½®ã€‚</p>

<p><strong>ä»£ç ç¤ºä¾‹</strong>ï¼š</p>

<p><strong>æœ€å¤§æ± åŒ–</strong>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">tools.common_tools</span> <span class="kn">import</span> <span class="n">transform_invert</span><span class="p">,</span> <span class="n">set_seed</span>

<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># è®¾ç½®éšæœºç§å­
</span>
<span class="c1"># ================================= load img ==================================
</span><span class="n">path_img</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="s">"lena.png"</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path_img</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">'RGB'</span><span class="p">)</span>  <span class="c1"># 0~255
</span>
<span class="c1"># convert to tensor
</span><span class="n">img_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">()])</span>
<span class="n">img_tensor</span> <span class="o">=</span> <span class="n">img_transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">img_tensor</span><span class="p">.</span><span class="n">unsqueeze_</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># C*H*W to B*C*H*W
</span>
<span class="c1"># ================================= create pooling layer ==================================
</span>
<span class="c1"># ================ maxpool
</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># flag = 0
</span><span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
    <span class="n">maxpool_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">MaxPool2d</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>   <span class="c1"># input:(i, o, size) weights:(o, i , h, w)
</span>    <span class="n">img_pool</span> <span class="o">=</span> <span class="n">maxpool_layer</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">)</span>

<span class="c1"># ================ avgpool
# flag = 1
</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
    <span class="n">avgpoollayer</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">AvgPool2d</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>   <span class="c1"># input:(i, o, size) weights:(o, i , h, w)
</span>    <span class="n">img_pool</span> <span class="o">=</span> <span class="n">avgpoollayer</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">)</span>

<span class="c1"># ================ avgpool divisor_override
# flag = 1
</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
    <span class="n">img_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">avgpool_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">AvgPool2d</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">divisor_override</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">img_pool</span> <span class="o">=</span> <span class="n">avgpool_layer</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"raw_img:</span><span class="se">\n</span><span class="s">{}</span><span class="se">\n</span><span class="s">pooling_img:</span><span class="se">\n</span><span class="s">{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">img_pool</span><span class="p">))</span>


<span class="c1"># ================ max unpool
# flag = 1
</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
    <span class="c1"># pooling
</span>    <span class="n">img_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="n">high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">maxpool_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">MaxPool2d</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">return_indices</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">img_pool</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">maxpool_layer</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">)</span>

    <span class="c1"># unpooling
</span>    <span class="n">img_reconstruct</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">img_pool</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">maxunpool_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">MaxUnpool2d</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">img_unpool</span> <span class="o">=</span> <span class="n">maxunpool_layer</span><span class="p">(</span><span class="n">img_reconstruct</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"raw_img:</span><span class="se">\n</span><span class="s">{}</span><span class="se">\n</span><span class="s">img_pool:</span><span class="se">\n</span><span class="s">{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">img_pool</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"img_reconstruct:</span><span class="se">\n</span><span class="s">{}</span><span class="se">\n</span><span class="s">img_unpool:</span><span class="se">\n</span><span class="s">{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">img_reconstruct</span><span class="p">,</span> <span class="n">img_unpool</span><span class="p">))</span>


<span class="c1"># ================ linear
# flag = 1
</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span>
    <span class="n">linear_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">linear_layer</span><span class="p">.</span><span class="n">weight</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>
                                             <span class="p">[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span>
                                             <span class="p">[</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">],</span>
                                             <span class="p">[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">]])</span>

    <span class="n">linear_layer</span><span class="p">.</span><span class="n">bias</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fill_</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">linear_layer</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">inputs</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">linear_layer</span><span class="p">.</span><span class="n">weight</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">linear_layer</span><span class="p">.</span><span class="n">weight</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">output</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>


<span class="c1"># ================================= visualization ==================================
</span><span class="k">print</span><span class="p">(</span><span class="s">"æ± åŒ–å‰å°ºå¯¸:{}</span><span class="se">\n</span><span class="s">æ± åŒ–åå°ºå¯¸:{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">img_pool</span><span class="p">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">img_pool</span> <span class="o">=</span> <span class="n">transform_invert</span><span class="p">(</span><span class="n">img_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">...],</span> <span class="n">img_transform</span><span class="p">)</span>
<span class="n">img_raw</span> <span class="o">=</span> <span class="n">transform_invert</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">img_transform</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">).</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_pool</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">).</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_raw</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-16-WX20201216-193358%402x.png" width="60%" /></p>

<p>ä¸‹èŠ‚å†…å®¹ï¼šnn ç½‘ç»œå±‚ï¼šæ± åŒ–å±‚ã€å…¨è¿æ¥å±‚å’Œæ¿€æ´»å‡½æ•°å±‚</p>
:ET