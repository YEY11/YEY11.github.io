I"kÖ<h1 id="lecture-17-ä¼˜åŒ–å™¨-ä¸€">Lecture 17 ä¼˜åŒ–å™¨ (ä¸€)</h1>

<p>å‰ä¸¤èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†æŸå¤±å‡½æ•°çš„æ¦‚å¿µä»¥åŠ PyTorch ä¸­çš„ä¸€ç³»åˆ—æŸå¤±å‡½æ•°æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“äº†æŸå¤±å‡½æ•°çš„ä½œç”¨æ˜¯è¡¡é‡æ¨¡å‹è¾“å‡ºä¸çœŸå®æ ‡ç­¾ä¹‹é—´çš„å·®å¼‚ã€‚åœ¨å¾—åˆ°äº† loss å‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•å»æ›´æ–°æ¨¡å‹å‚æ•°ï¼Œä½¿å¾— loss é€æ­¥é™ä½å‘¢ï¼Ÿè¿™æ­£æ˜¯ä¼˜åŒ–å™¨çš„å·¥ä½œã€‚æœ¬èŠ‚è¯¾æˆ‘ä»¬å¼€å§‹å­¦ä¹ ä¼˜åŒ–å™¨æ¨¡å—ã€‚</p>

<h2 id="1-ä»€ä¹ˆæ˜¯ä¼˜åŒ–å™¨">1. ä»€ä¹ˆæ˜¯ä¼˜åŒ–å™¨</h2>

<p>åœ¨å­¦ä¹ ä¼˜åŒ–å™¨æ¨¡å—ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹æœºå™¨å­¦ä¹ æ¨¡å‹è®­ç»ƒçš„ 5 ä¸ªæ­¥éª¤ï¼š</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-11-WX20201211-145639%402x.png" width="90%" /></p>

<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œä¼˜åŒ–å™¨æ˜¯ç¬¬ 4 ä¸ªæ¨¡å—ï¼Œé‚£ä¹ˆå®ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å‰ä¸€æ­¥çš„æŸå¤±å‡½æ•°æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ª loss å€¼ï¼Œå³æ¨¡å‹è¾“å‡ºä¸çœŸå®æ ‡ç­¾ä¹‹é—´çš„å·®å¼‚ã€‚æœ‰äº† loss å€¼ä¹‹åï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé‡‡ç”¨ PyTorch ä¸­çš„ AutoGrid è‡ªåŠ¨æ¢¯åº¦æ±‚å¯¼æ¨¡å—å¯¹æ¨¡å‹ä¸­å‚æ•°çš„æ¢¯åº¦è¿›è¡Œæ±‚å¯¼è®¡ç®—ï¼Œä¹‹åä¼˜åŒ–å™¨ä¼šæ‹¿åˆ°è¿™äº›æ¢¯åº¦å€¼å¹¶é‡‡ç”¨ä¸€äº›ä¼˜åŒ–ç­–ç•¥å»æ›´æ–°æ¨¡å‹å‚æ•°ï¼Œä½¿å¾— loss å€¼ä¸‹é™ã€‚å› æ­¤ï¼Œä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯åˆ©ç”¨æ¢¯åº¦æ¥æ›´æ–°æ¨¡å‹ä¸­çš„å¯å­¦ä¹ å‚æ•°ï¼Œä½¿å¾—æ¨¡å‹è¾“å‡ºä¸çœŸå®æ ‡ç­¾ä¹‹é—´çš„å·®å¼‚æ›´å°ï¼Œå³è®© loss å€¼ä¸‹é™ã€‚</p>

<p><strong>PyTorch çš„ä¼˜åŒ–å™¨</strong>ï¼š<strong>ç®¡ç†</strong> å¹¶ <strong>æ›´æ–°</strong> æ¨¡å‹ä¸­å¯å­¦ä¹ å‚æ•° (æƒå€¼æˆ–åç½®) çš„å€¼ï¼Œä½¿å¾—æ¨¡å‹è¾“å‡ºæ›´æ¥è¿‘çœŸå®æ ‡ç­¾ã€‚</p>

<p><img src="http://andy-blog.oss-cn-beijing.aliyuncs.com/blog/2020-12-27-WX20201227-123649%402x.png" width="80%" /></p>

<ul>
  <li><strong>å¯¼æ•°</strong>ï¼šå‡½æ•°åœ¨æŒ‡å®šåæ ‡è½´ä¸Šçš„å˜åŒ–ç‡ã€‚</li>
  <li><strong>æ–¹å‘å¯¼æ•°</strong>ï¼šæŒ‡å®šæ–¹å‘ä¸Šçš„å˜åŒ–ç‡ã€‚</li>
  <li><strong>æ¢¯åº¦</strong>ï¼šä¸€ä¸ªå‘é‡ï¼Œæ–¹å‘ä¸ºæ–¹å‘å¯¼æ•°å–å¾—æœ€å¤§å€¼çš„æ–¹å‘ã€‚</li>
</ul>

<h2 id="2-optimizer-çš„å±æ€§">2. Optimizer çš„å±æ€§</h2>

<p><strong>PyTorch ä¸­çš„ Optimizer ç±»</strong>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Optimizer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">defaults</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">defaults</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">param_groups</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">param_groups</span> <span class="o">=</span> <span class="p">[{</span><span class="s">'params'</span><span class="p">:</span> <span class="n">param_groups</span><span class="p">}]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>åŸºæœ¬å±æ€§</strong>ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">defaults</code>ï¼šä¼˜åŒ–å™¨è¶…å‚æ•°ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">state</code>ï¼šå‚æ•°çš„ç¼“å­˜ï¼Œå¦‚ <code class="language-plaintext highlighter-rouge">momentum</code> çš„ç¼“å­˜ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">params_groups</code>ï¼šç®¡ç†çš„å‚æ•°ç»„ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">_ step_count</code>ï¼šè®°å½•æ›´æ–°æ¬¡æ•°ï¼Œå­¦ä¹ ç‡è°ƒæ•´ä¸­ä½¿ç”¨ã€‚</li>
</ul>

<h2 id="3-optimizer-çš„æ–¹æ³•">3. Optimizer çš„æ–¹æ³•</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Optimizer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">zero_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">param_groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s">'params'</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">p</span><span class="p">.</span><span class="n">grad</span><span class="p">.</span><span class="n">detach_</span><span class="p">()</span>
                    <span class="n">p</span><span class="p">.</span><span class="n">grad</span><span class="p">.</span><span class="n">zero_</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_param_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_group</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">param_groups</span><span class="p">:</span>
            <span class="n">param_set</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s">'paramsâ€™]))
        self.param_groups.append(param_group)
    
    def state_dict(self):
        return {'</span><span class="n">state</span><span class="s">': packed_state, '</span><span class="n">param_groups</span><span class="s">': param_groups,}

    def load_state_dict(self, state_dict):
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>åŸºæœ¬æ–¹æ³•</strong>ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">zero_grad()</code>ï¼šæ¸…ç©ºæ‰€ç®¡ç†å‚æ•°çš„æ¢¯åº¦ (PyTorch ç‰¹æ€§ï¼šå¼ é‡æ¢¯åº¦ä¸è‡ªåŠ¨æ¸…é›¶)ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">step()</code>ï¼šæ‰§è¡Œä¸€æ­¥æ›´æ–°ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">add_param_group()</code>ï¼šæ·»åŠ å‚æ•°ç»„ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">state_dict()</code>ï¼šè·å–ä¼˜åŒ–å™¨å½“å‰çŠ¶æ€ä¿¡æ¯ <strong>å­—å…¸</strong>ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">load_state_dict()</code>ï¼šåŠ è½½çŠ¶æ€ä¿¡æ¯å­—å…¸ã€‚</li>
</ul>

<h3 id="ä¾‹å­äººæ°‘å¸äºŒåˆ†ç±»">ä¾‹å­ï¼šäººæ°‘å¸äºŒåˆ†ç±»</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
</pre></td><td class="rouge-code"><pre><span class="c1"># -*- coding: utf-8 -*-
</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="n">transforms</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">model.lenet</span> <span class="kn">import</span> <span class="n">LeNet</span>
<span class="kn">from</span> <span class="nn">tools.my_dataset</span> <span class="kn">import</span> <span class="n">RMBDataset</span>
<span class="kn">from</span> <span class="nn">tools.common_tools</span> <span class="kn">import</span> <span class="n">transform_invert</span><span class="p">,</span> <span class="n">set_seed</span>

<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># è®¾ç½®éšæœºç§å­
</span><span class="n">rmb_label</span> <span class="o">=</span> <span class="p">{</span><span class="s">"1"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"100"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="c1"># å‚æ•°è®¾ç½®
</span><span class="n">MAX_EPOCH</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">LR</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">log_interval</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">val_interval</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># ============================ step 1/5 æ•°æ® ============================
</span>
<span class="n">split_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">".."</span><span class="p">,</span> <span class="s">".."</span><span class="p">,</span> <span class="s">"data"</span><span class="p">,</span> <span class="s">"rmb_split"</span><span class="p">)</span>
<span class="n">train_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_dir</span><span class="p">,</span> <span class="s">"train"</span><span class="p">)</span>
<span class="n">valid_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_dir</span><span class="p">,</span> <span class="s">"valid"</span><span class="p">)</span>

<span class="n">norm_mean</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">]</span>
<span class="n">norm_std</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]</span>

<span class="n">train_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">transforms</span><span class="p">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span>
    <span class="n">transforms</span><span class="p">.</span><span class="n">RandomCrop</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
    <span class="n">transforms</span><span class="p">.</span><span class="n">RandomGrayscale</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.8</span><span class="p">),</span>
    <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">norm_mean</span><span class="p">,</span> <span class="n">norm_std</span><span class="p">),</span>
<span class="p">])</span>

<span class="n">valid_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">transforms</span><span class="p">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span>
    <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">norm_mean</span><span class="p">,</span> <span class="n">norm_std</span><span class="p">),</span>
<span class="p">])</span>

<span class="c1"># æ„å»ºMyDatasetå®ä¾‹
</span><span class="n">train_data</span> <span class="o">=</span> <span class="n">RMBDataset</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">train_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">train_transform</span><span class="p">)</span>
<span class="n">valid_data</span> <span class="o">=</span> <span class="n">RMBDataset</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">valid_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">valid_transform</span><span class="p">)</span>

<span class="c1"># æ„å»ºDataLoder
</span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">valid_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">valid_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>

<span class="c1"># ============================ step 2/5 æ¨¡å‹ ============================
</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">LeNet</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">net</span><span class="p">.</span><span class="n">initialize_weights</span><span class="p">()</span>

<span class="c1"># ============================ step 3/5 æŸå¤±å‡½æ•° ============================
</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>                                                   <span class="c1"># é€‰æ‹©æŸå¤±å‡½æ•°
</span>
<span class="c1"># ============================ step 4/5 ä¼˜åŒ–å™¨ ============================
</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">net</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LR</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>                        <span class="c1"># é€‰æ‹©ä¼˜åŒ–å™¨
</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">lr_scheduler</span><span class="p">.</span><span class="n">StepLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>     <span class="c1"># è®¾ç½®å­¦ä¹ ç‡ä¸‹é™ç­–ç•¥
</span>
<span class="c1"># ============================ step 5/5 è®­ç»ƒ ============================
</span><span class="n">train_curve</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">valid_curve</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_EPOCH</span><span class="p">):</span>

    <span class="n">loss_mean</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="n">net</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>

        <span class="c1"># forward
</span>        <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

        <span class="c1"># backward
</span>        <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>

        <span class="c1"># update weights
</span>        <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># ç»Ÿè®¡åˆ†ç±»æƒ…å†µ
</span>        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">).</span><span class="n">squeeze</span><span class="p">().</span><span class="nb">sum</span><span class="p">().</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># æ‰“å°è®­ç»ƒä¿¡æ¯
</span>        <span class="n">loss_mean</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">train_curve</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">log_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">loss_mean</span> <span class="o">=</span> <span class="n">loss_mean</span> <span class="o">/</span> <span class="n">log_interval</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Training:Epoch[{:0&gt;3}/{:0&gt;3}] Iteration[{:0&gt;3}/{:0&gt;3}] Loss: {:.4f} Acc:{:.2%}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
                <span class="n">epoch</span><span class="p">,</span> <span class="n">MAX_EPOCH</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">),</span> <span class="n">loss_mean</span><span class="p">,</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span><span class="p">))</span>
            <span class="n">loss_mean</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="n">scheduler</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>  <span class="c1"># æ›´æ–°å­¦ä¹ ç‡
</span>
    <span class="c1"># validate the model
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">val_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">correct_val</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">total_val</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">loss_val</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">net</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_loader</span><span class="p">):</span>
                <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

                <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">total_val</span> <span class="o">+=</span> <span class="n">labels</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">correct_val</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">).</span><span class="n">squeeze</span><span class="p">().</span><span class="nb">sum</span><span class="p">().</span><span class="n">numpy</span><span class="p">()</span>

                <span class="n">loss_val</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span>

            <span class="n">valid_curve</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_val</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Valid:</span><span class="se">\t</span><span class="s"> Epoch[{:0&gt;3}/{:0&gt;3}] Iteration[{:0&gt;3}/{:0&gt;3}] Loss: {:.4f} Acc:{:.2%}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
                <span class="n">epoch</span><span class="p">,</span> <span class="n">MAX_EPOCH</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_loader</span><span class="p">),</span> <span class="n">loss_val</span><span class="p">,</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span><span class="p">))</span>


<span class="n">train_x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_curve</span><span class="p">))</span>
<span class="n">train_y</span> <span class="o">=</span> <span class="n">train_curve</span>

<span class="n">train_iters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<span class="n">valid_x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_curve</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">train_iters</span><span class="o">*</span><span class="n">val_interval</span> <span class="c1"># ç”±äºvalidä¸­è®°å½•çš„æ˜¯epochlossï¼Œéœ€è¦å¯¹è®°å½•ç‚¹è¿›è¡Œè½¬æ¢åˆ°iterations
</span><span class="n">valid_y</span> <span class="o">=</span> <span class="n">valid_curve</span>

<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Train'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">valid_x</span><span class="p">,</span> <span class="n">valid_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Valid'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'upper right'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'loss value'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Iteration'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># ============================ inference ============================
</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">test_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">"test_data"</span><span class="p">)</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="n">RMBDataset</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">test_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">valid_transform</span><span class="p">)</span>
<span class="n">valid_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_loader</span><span class="p">):</span>
    <span class="c1"># forward
</span>    <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">rmb</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">predicted</span><span class="p">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">100</span>

    <span class="n">img_tensor</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">...]</span>  <span class="c1"># C H W
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">transform_invert</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">train_transform</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"LeNet got {} Yuan"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">rmb</span><span class="p">))</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¼˜åŒ–å™¨ä¸­çš„ 5 ç§åŸºæœ¬æ–¹æ³•çš„å…·ä½“ä½¿ç”¨æ–¹å¼ï¼š</p>

<h4 id="step"><code class="language-plaintext highlighter-rouge">step()</code></h4>

<p>ä¸ºäº†æ–¹ä¾¿è®¡ç®—ï¼Œæˆ‘ä»¬å…ˆè®¾ç½®å­¦ä¹ ç‡ <code class="language-plaintext highlighter-rouge">lr=1</code>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">tools.common_tools</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>

<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># è®¾ç½®éšæœºç§å­
</span>
<span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randn</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">weight</span><span class="p">.</span><span class="n">grad</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">([</span><span class="n">weight</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"weight before step:{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">weight</span><span class="p">.</span><span class="n">data</span><span class="p">))</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>        <span class="c1"># ä¿®æ”¹lr=1 0.1è§‚å¯Ÿç»“æœ
</span><span class="k">print</span><span class="p">(</span><span class="s">"weight after step:{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">weight</span><span class="p">.</span><span class="n">data</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>weight before step:tensor([[0.6614, 0.2669],
        [0.0617, 0.6213]])
weight after step:tensor([[-0.3386, -0.7331],
        [-0.9383, -0.3787]])
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªæ¢¯åº¦åœ¨æ›´æ–°ä¹‹å‰çš„å€¼ä¸º $0.6614$ï¼Œæ›´æ–°ä¹‹åçš„å€¼ä¸º $0.6614 - 1 = -0.3386$ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ç‡è®¾ç½®ä¸º <code class="language-plaintext highlighter-rouge">lr=0.1</code>ï¼Œè§‚å¯Ÿç»“æœæ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">([</span><span class="n">weight</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>weight before step:tensor([[0.6614, 0.2669],
        [0.0617, 0.6213]])
weight after step:tensor([[ 0.5614,  0.1669],
        [-0.0383,  0.5213]])
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªæ¢¯åº¦æ›´æ–°åçš„å€¼å˜ä¸ºäº† $0.6614 - 0.1 = 0.5614$ã€‚è¿™å°±æ˜¯ <code class="language-plaintext highlighter-rouge">step()</code> æ–¹æ³•çš„ä¸€æ­¥æ›´æ–°ã€‚</p>

<h4 id="zero_grad-"><code class="language-plaintext highlighter-rouge">zero_grad ()</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">print</span><span class="p">(</span><span class="s">"weight before step:{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">weight</span><span class="p">.</span><span class="n">data</span><span class="p">))</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>        <span class="c1"># ä¿®æ”¹lr=1 0.1è§‚å¯Ÿç»“æœ
</span><span class="k">print</span><span class="p">(</span><span class="s">"weight after step:{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">weight</span><span class="p">.</span><span class="n">data</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">"weight in optimizer:{}</span><span class="se">\n</span><span class="s">weight in weight:{}</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'params'</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">id</span><span class="p">(</span><span class="n">weight</span><span class="p">)))</span>

<span class="k">print</span><span class="p">(</span><span class="s">"weight.grad is {}</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">weight</span><span class="p">.</span><span class="n">grad</span><span class="p">))</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"after optimizer.zero_grad(), weight.grad is</span><span class="se">\n</span><span class="s">{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">weight</span><span class="p">.</span><span class="n">grad</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>weight before step:tensor([[0.6614, 0.2669],
        [0.0617, 0.6213]])
weight after step:tensor([[ 0.5614,  0.1669],
        [-0.0383,  0.5213]])
weight in optimizer:4729862544
weight in weight:4729862544
weight.grad is tensor([[1., 1.],
        [1., 1.]])
after optimizer.zero_grad(), weight.grad is
tensor([[0., 0.],
        [0., 0.]])
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">zero_grad()</code> ä¹‹å‰ï¼Œæˆ‘ä»¬çš„æ¢¯åº¦ä¸º $[[1., 1.],[1., 1.]]$ï¼Œæ‰§è¡Œä¹‹åå˜ä¸ºäº† $[[0., 0.],[0., 0.]]$ã€‚å¦å¤–ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œoptimizer ä¸­ç®¡ç†çš„ <code class="language-plaintext highlighter-rouge">weight</code> çš„å†…å­˜åœ°å€å’ŒçœŸå®çš„ <code class="language-plaintext highlighter-rouge">weight</code> åœ°å€æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¼˜åŒ–å™¨ä¸­ä¿å­˜çš„æ˜¯å‚æ•°çš„åœ°å€ï¼Œè€Œä¸æ˜¯æ‹·è´çš„å‚æ•°çš„å€¼ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœå†…å­˜æ¶ˆè€—ã€‚</p>

<h4 id="add_param_group-"><code class="language-plaintext highlighter-rouge">add_param_group ()</code></h4>

<p>æˆ‘ä»¬åŒæ ·é‡‡ç”¨ä¸Šé¢çš„ä¼˜åŒ–å™¨ï¼Œè¯¥ä¼˜åŒ–å™¨å½“å‰å·²ç»ç®¡ç†äº†ä¸€ç»„å‚æ•°ï¼Œå°±æ˜¯æˆ‘ä»¬çš„ <code class="language-plaintext highlighter-rouge">weight</code>ã€‚ç°åœ¨æˆ‘ä»¬å¸Œæœ›å†å¢åŠ ä¸€ç»„å‚æ•°ï¼Œå¹¶ä¸”æˆ‘ä»¬å°†è¯¥ç»„å‚æ•°çš„å­¦ä¹ ç‡è®¾ç½®çš„æ›´å°ä¸€äº› <code class="language-plaintext highlighter-rouge">lr=0.0001</code>ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºè¿™æ ·ä¸€ç»„å‚æ•°çš„å­—å…¸ï¼Œå­—å…¸çš„ key è®¾ç½®ä¸º <code class="language-plaintext highlighter-rouge">'params'</code>ï¼Œå…¶å€¼ä¸ºæ–°çš„ä¸€ç»„å‚æ•° <code class="language-plaintext highlighter-rouge">w2</code>ï¼›ç„¶åå¯ä»¥è®¾ç½®ä¸€äº›è¶…å‚æ•°ï¼Œä¾‹å¦‚å­¦ä¹ ç‡ <code class="language-plaintext highlighter-rouge">'lr'</code> ç­‰ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">add_param_group ()</code> å°†è¿™ç»„å‚æ•°åŠ å…¥ä¼˜åŒ–å™¨ä¸­ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">print</span><span class="p">(</span><span class="s">"optimizer.param_groups is</span><span class="se">\n</span><span class="s">{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">param_groups</span><span class="p">))</span>
<span class="n">w2</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randn</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">add_param_group</span><span class="p">({</span><span class="s">"params"</span><span class="p">:</span> <span class="n">w2</span><span class="p">,</span> <span class="s">'lr'</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">})</span>
<span class="k">print</span><span class="p">(</span><span class="s">"optimizer.param_groups is</span><span class="se">\n</span><span class="s">{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">param_groups</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>optimizer.param_groups is
[{'params': [tensor([[0.6614, 0.2669],
        [0.0617, 0.6213]], requires_grad=True)], 'lr': 0.1, 'momentum': 0, 'dampening': 0, 'weight_decay': 0, 'nesterov': False}]
optimizer.param_groups is
[{'params': [tensor([[0.6614, 0.2669],
        [0.0617, 0.6213]], requires_grad=True)], 'lr': 0.1, 'momentum': 0, 'dampening': 0, 'weight_decay': 0, 'nesterov': False}, {'params': [tensor([[-0.4519, -0.1661, -1.5228],
        [ 0.3817, -1.0276, -0.5631],
        [-0.8923, -0.0583, -0.1955]], requires_grad=True)], 'lr': 0.0001, 'momentum': 0, 'dampening': 0, 'weight_decay': 0, 'nesterov': False}]
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åŠ å…¥æ–°å‚æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬çš„ä¼˜åŒ–å™¨ä¸­åªæœ‰ä¸€ç»„å‚æ•°ï¼Œä»¥ä¸€ä¸ªåˆ—è¡¨å½¢å¼å‘ˆç°ï¼Œé‡Œé¢åªæœ‰ä¸€ä¸ªå­—å…¸å…ƒç´ ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">add_param_group ()</code> ä¹‹åï¼Œåˆ—è¡¨ä¸­æœ‰äº†ä¸¤ä¸ªå­—å…¸å…ƒç´ ã€‚å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ç»„å‚æ•°çš„å­¦ä¹ ç‡æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥é€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä»¬å¯ä»¥ä¸ºä¸åŒçš„å‚æ•°ç»„è®¾ç½®ä¸åŒçš„å­¦ä¹ ç‡ï¼Œè¿™åœ¨æ¨¡å‹æ‹Ÿåˆè¿‡ç¨‹ä¸­æ˜¯ä¸€ç§éå¸¸å®ç”¨çš„æ–¹æ³•ã€‚</p>

<h4 id="state_dict-å’Œ-load_state_dict"><code class="language-plaintext highlighter-rouge">state_dict()</code> å’Œ <code class="language-plaintext highlighter-rouge">load_state_dict()</code></h4>

<p>è¿™ä¸¤ä¸ªå‡½æ•°ç”¨äºä¿å­˜ä¼˜åŒ–å™¨çš„çŠ¶æ€ä¿¡æ¯ï¼Œé€šå¸¸ç”¨äºæ–­ç‚¹çš„ç»§ç»­è®­ç»ƒã€‚</p>

<p><strong>ä¿å­˜çŠ¶æ€ä¿¡æ¯</strong>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">([</span><span class="n">weight</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">opt_state_dict</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">state_dict</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"state_dict before step:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">opt_state_dict</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"state_dict after step:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">state_dict</span><span class="p">())</span>

<span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">"optimizer_state_dict.pkl"</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>state_dict before step:
 {'state': {}, 'param_groups': [{'lr': 0.1, 'momentum': 0.9, 'dampening': 0, 'weight_decay': 0, 'nesterov': False, 'params': [4745884296]}]}
state_dict after step:
 {'state': {4745884296: {'momentum_buffer': tensor([[6.5132, 6.5132],
        [6.5132, 6.5132]])}}, 'param_groups': [{'lr': 0.1, 'momentum': 0.9, 'dampening': 0, 'weight_decay': 0, 'nesterov': False, 'params': [4745884296]}]}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ›´æ–°ä¹‹å‰ï¼Œ<code class="language-plaintext highlighter-rouge">'state'</code> é‡Œçš„å€¼æ˜¯ä¸€ä¸ªç©ºå­—å…¸ã€‚åœ¨ç»è¿‡ 10 æ­¥æ›´æ–°ä¹‹åï¼Œ<code class="language-plaintext highlighter-rouge">'state'</code> å­—å…¸ä¸­æœ‰äº†ä¸€äº›å€¼ï¼Œå®ƒçš„ key æ˜¯ <code class="language-plaintext highlighter-rouge">4745884296</code>ï¼Œå³å‚æ•°åœ°å€ï¼Œè€Œå®ƒçš„å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå­—å…¸ã€‚å…¶ä¸­ <code class="language-plaintext highlighter-rouge">'momentum_buffer'</code> æ˜¯åŠ¨é‡ä¸­ä¼šä½¿ç”¨çš„ä¸€äº›ç¼“å­˜ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œåœ¨ <code class="language-plaintext highlighter-rouge">'state'</code> ä¸­æˆ‘ä»¬æ˜¯é€šè¿‡åœ°å€å»åŒ¹é…å‚æ•°çš„ç¼“å­˜çš„ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">torch.save</code> å¯¹å­—å…¸è¿›è¡Œåºåˆ—åŒ–ï¼Œå°†å…¶ä¿å­˜ä¸ºä¸€ä¸ª <code class="language-plaintext highlighter-rouge">pkl</code> çš„å½¢å¼ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸‹å¤šäº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">optimizer_state_dict.pkl</code> çš„æ–‡ä»¶ã€‚</p>

<p><strong>è¯»å–çŠ¶æ€ä¿¡æ¯</strong>ï¼š</p>

<p>ä¹‹å‰æˆ‘ä»¬çš„æ¨¡å‹å·²ç»è®­ç»ƒäº† 10 æ¬¡ï¼Œå‡è®¾æˆ‘ä»¬æ€»å…±éœ€è¦è®­ç»ƒ 100 æ¬¡ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å†ä»å¤´è®­ç»ƒï¼Œè€Œæ˜¯å¸Œæœ›èƒ½å¤Ÿæ¥ç€ä¹‹å‰ç¬¬ 10 æ¬¡çš„çŠ¶æ€ç»§ç»­è®­ç»ƒï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code class="language-plaintext highlighter-rouge">load_state_dict</code> åŠ è½½å‰é¢ä¿å­˜çš„ <code class="language-plaintext highlighter-rouge">optimizer_state_dict.pkl</code> æ–‡ä»¶ï¼Œå¹¶å°†å…¶è¯»å–åŠ è½½åˆ°ä¼˜åŒ–å™¨ä¸­ç»§ç»­è®­ç»ƒï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">([</span><span class="n">weight</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">"optimizer_state_dict.pkl"</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">"state_dict before load state:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">state_dict</span><span class="p">())</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"state_dict after load state:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">state_dict</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>state_dict before load state:
 {'state': {}, 'param_groups': [{'lr': 0.1, 'momentum': 0.9, 'dampening': 0, 'weight_decay': 0, 'nesterov': False, 'params': [4684949616]}]}
state_dict after load state:
 {'state': {4684949616: {'momentum_buffer': tensor([[6.5132, 6.5132],
        [6.5132, 6.5132]])}}, 'param_groups': [{'lr': 0.1, 'momentum': 0.9, 'dampening': 0, 'weight_decay': 0, 'nesterov': False, 'params': [4684949616]}]}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åŠ è½½ä¹‹å‰ï¼Œ<code class="language-plaintext highlighter-rouge">'state'</code> é‡Œçš„å€¼æ˜¯ä¸€ä¸ªç©ºå­—å…¸ã€‚åœ¨ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">load_state_dict</code> åŠ è½½ä¹‹åï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¹‹å‰ç¬¬ 10 æ¬¡çš„å‚æ•°çŠ¶æ€ï¼Œç„¶åç»§ç»­åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œè®­ç»ƒå³å¯ã€‚</p>

<h2 id="4-æ€»ç»“">4. æ€»ç»“</h2>

<p>æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ä¼˜åŒ–å™¨ Optimizer çš„æ¦‚å¿µå’Œä¸€äº›åŸºæœ¬å±æ€§åŠæ–¹æ³•ã€‚åœ¨ä¸‹èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†ç»§ç»­å­¦ä¹  PyTorch ä¸­çš„ä¸€äº›å¸¸ç”¨çš„ä¼˜åŒ–æ–¹æ³• (ä¼˜åŒ–å™¨)ã€‚</p>

<p>ä¸‹èŠ‚å†…å®¹ï¼šä¼˜åŒ–å™¨ (äºŒ)</p>
:ET